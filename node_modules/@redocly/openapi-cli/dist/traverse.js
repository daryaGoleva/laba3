"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _resolver = _interopRequireWildcard(require("./resolver"));

var _resolveDefinition = _interopRequireDefault(require("./resolveDefinition"));

var _resolveType = _interopRequireDefault(require("./resolveType"));

var _scalarsResolver = _interopRequireDefault(require("./scalarsResolver"));

var _default2 = require("./error/default");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-await-in-loop */

/* eslint-disable no-underscore-dangle */

/* eslint-disable no-case-declarations */
async function traverseChildren(resolvedNode, definition, ctx, visited) {
  let nodeChildren;
  const errors = [];

  switch (typeof definition.properties) {
    case 'function':
      nodeChildren = definition.properties(resolvedNode);
      const childrenNames = Object.keys(nodeChildren);
      const resolvedNodeKeys = Object.keys(resolvedNode);

      for (let i = 0; i < childrenNames.length; i += 1) {
        const child = childrenNames[i];
        let childResult = [];

        if (resolvedNodeKeys.includes(child)) {
          ctx.path.push(child);

          if (resolvedNode[child]) {
            childResult = await traverseNode(resolvedNode[child], nodeChildren[child], ctx, visited);
          }

          if (childResult) errors.push(...childResult);
          ctx.path.pop();
        }
      }

      break;

    case 'object':
      const props = Object.keys(definition.properties);

      for (let i = 0; i < props.length; i += 1) {
        const p = props[i];
        let propResult = [];
        ctx.path.push(p);

        if (typeof definition.properties[p] === 'function') {
          if (resolvedNode[p]) {
            propResult = await traverseNode(resolvedNode[p], definition.properties[p](resolvedNode[p]), ctx, visited);
          }
        } else if (resolvedNode[p]) {
          propResult = await traverseNode(resolvedNode[p], definition.properties[p], ctx, visited);
        }

        if (propResult) errors.push(...propResult);
        ctx.path.pop();
      }

      break;

    default: // do nothing

  }

  return errors;
}

async function onNodeEnter(node, ctx) {
  const {
    node: resolvedNode,
    onStack
  } = await (0, _resolver.default)(node, ctx);
  return {
    resolvedNode,
    onStack
  };
}

function onNodeExit(nodeContext, ctx) {
  if (nodeContext.onStack) {
    (0, _resolver.popPath)(ctx);
  }
}

const nestedIncludes = (c, s) => {
  const res = s.find(el => el === s) !== undefined;
  return res;
};

async function traverseNode(node, definition, ctx, visited = []) {
  if (!node || !definition) return [];
  const nodeContext = await onNodeEnter(node, ctx);
  const isRecursive = nestedIncludes(ctx.path, visited);
  const errors = [];
  const currentPath = `${_path.default.relative(process.cwd(), ctx.filePath)}::${ctx.path.join('/')}`;
  const localVisited = Array.from(visited);
  localVisited.push(currentPath);
  const resolvedDefinition = (0, _resolveDefinition.default)(definition, ctx, nodeContext.resolvedNode);
  ctx.definitionStack.push(resolvedDefinition);
  (0, _scalarsResolver.default)(nodeContext.resolvedNode, definition, ctx);

  if (definition.customResolveFields) {
    await definition.customResolveFields(nodeContext.resolvedNode, ctx, visited);
  }

  if (Array.isArray(nodeContext.resolvedNode)) {
    for (let i = 0; i < nodeContext.resolvedNode.length; i++) {
      ctx.path.push(i);
      const arrayResult = await traverseNode(nodeContext.resolvedNode[i], resolvedDefinition, ctx, localVisited);
      if (arrayResult) errors.push(...arrayResult);
      ctx.path.pop();
    }
  } else {
    ctx.validateFields = ctx.validateFieldsRaw.bind(null, nodeContext.resolvedNode, ctx);
    await runRuleOnRuleset(nodeContext, 'onEnter', ctx, resolvedDefinition, node, errors, localVisited);
    const newNode = !isRecursive && (!resolvedDefinition.isIdempotent || !ctx.visited.includes(currentPath));

    if (newNode) {
      if (!ctx.visited.includes(currentPath)) ctx.visited.push(currentPath);
      const errorsChildren = await traverseChildren(nodeContext.resolvedNode, resolvedDefinition, ctx, localVisited);
      errors.push(...errorsChildren);
    } else {
      // Will use cached result if we have already traversed this nodes children
      const cachedResult = ctx.cache[currentPath] ? ctx.cache[currentPath].map(r => (0, _default2.fromError)(r, ctx)) : [];
      ctx.result.push(...cachedResult);
    }

    await runRuleOnRuleset(nodeContext, 'onExit', ctx, resolvedDefinition, node, errors);
    if (newNode) ctx.cache[currentPath] = errors;
  }

  onNodeExit(nodeContext, ctx);
  ctx.definitionStack.pop();
  return errors;
}

async function runRuleOnRuleset(nodeContext, ruleName, ctx, definition, node, errors, visited) {
  for (let i = 0; i < ctx.customRules.length; i += 1) {
    ctx.validateFieldsHelper = ctx.validateFields.bind(null, ctx.customRules[i]._config, ctx.customRules[i].constructor.rule);
    ctx.createError = _default2.createErrorFlat.bind(null, nodeContext.resolvedNode, ctx, ctx.customRules[i].constructor.rule, ctx.customRules[i].config ? ctx.customRules[i].config.level : ctx.customRules[i]._config.level);
    const errorsOnEnterForType = ctx.customRules[i][definition.name] && ctx.customRules[i][definition.name]()[ruleName] ? await ctx.customRules[i][definition.name]()[ruleName](nodeContext.resolvedNode, definition, ctx, node, {
      traverseNode,
      visited,
      resolveType: _resolveType.default
    }) : [];
    const errorsOnEnterGeneric = ctx.customRules[i].any && ctx.customRules[i].any()[ruleName] ? await ctx.customRules[i].any()[ruleName](nodeContext.resolvedNode, definition, ctx, node, {
      traverseNode,
      visited,
      resolveType: _resolveType.default
    }) : [];

    if (Array.isArray(errorsOnEnterForType)) {
      ctx.result.push(...errorsOnEnterForType);
      errors.push(...errorsOnEnterForType);
    }

    if (Array.isArray(errorsOnEnterGeneric)) {
      ctx.result.push(...errorsOnEnterGeneric);
      errors.push(...errorsOnEnterGeneric);
    }
  }
}

var _default = traverseNode;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmF2ZXJzZS5qcyJdLCJuYW1lcyI6WyJ0cmF2ZXJzZUNoaWxkcmVuIiwicmVzb2x2ZWROb2RlIiwiZGVmaW5pdGlvbiIsImN0eCIsInZpc2l0ZWQiLCJub2RlQ2hpbGRyZW4iLCJlcnJvcnMiLCJwcm9wZXJ0aWVzIiwiY2hpbGRyZW5OYW1lcyIsIk9iamVjdCIsImtleXMiLCJyZXNvbHZlZE5vZGVLZXlzIiwiaSIsImxlbmd0aCIsImNoaWxkIiwiY2hpbGRSZXN1bHQiLCJpbmNsdWRlcyIsInBhdGgiLCJwdXNoIiwidHJhdmVyc2VOb2RlIiwicG9wIiwicHJvcHMiLCJwIiwicHJvcFJlc3VsdCIsIm9uTm9kZUVudGVyIiwibm9kZSIsIm9uU3RhY2siLCJvbk5vZGVFeGl0Iiwibm9kZUNvbnRleHQiLCJuZXN0ZWRJbmNsdWRlcyIsImMiLCJzIiwicmVzIiwiZmluZCIsImVsIiwidW5kZWZpbmVkIiwiaXNSZWN1cnNpdmUiLCJjdXJyZW50UGF0aCIsInJlbGF0aXZlIiwicHJvY2VzcyIsImN3ZCIsImZpbGVQYXRoIiwiam9pbiIsImxvY2FsVmlzaXRlZCIsIkFycmF5IiwiZnJvbSIsInJlc29sdmVkRGVmaW5pdGlvbiIsImRlZmluaXRpb25TdGFjayIsImN1c3RvbVJlc29sdmVGaWVsZHMiLCJpc0FycmF5IiwiYXJyYXlSZXN1bHQiLCJ2YWxpZGF0ZUZpZWxkcyIsInZhbGlkYXRlRmllbGRzUmF3IiwiYmluZCIsInJ1blJ1bGVPblJ1bGVzZXQiLCJuZXdOb2RlIiwiaXNJZGVtcG90ZW50IiwiZXJyb3JzQ2hpbGRyZW4iLCJjYWNoZWRSZXN1bHQiLCJjYWNoZSIsIm1hcCIsInIiLCJyZXN1bHQiLCJydWxlTmFtZSIsImN1c3RvbVJ1bGVzIiwidmFsaWRhdGVGaWVsZHNIZWxwZXIiLCJfY29uZmlnIiwiY29uc3RydWN0b3IiLCJydWxlIiwiY3JlYXRlRXJyb3IiLCJjcmVhdGVFcnJvckZsYXQiLCJjb25maWciLCJsZXZlbCIsImVycm9yc09uRW50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aEIsRUFBbUJpRSxHQUFuQixHQUF5QmQsUUFBekIsQ0FBMUIsR0FDekIsTUFBTTVELEdBQUcsQ0FBQzZELFdBQUosQ0FBZ0JwRCxDQUFoQixFQUFtQmlFLEdBQW5CLEdBQXlCZCxRQUF6QixFQUFtQ25DLFdBQVcsQ0FBQzNCLFlBQS9DLEVBQTZEQyxVQUE3RCxFQUF5RUMsR0FBekUsRUFBOEVzQixJQUE5RSxFQUFvRjtBQUMxRk4sTUFBQUEsWUFEMEY7QUFDNUVmLE1BQUFBLE9BRDRFO0FBQ25FdUUsTUFBQUEsV0FBVyxFQUFYQTtBQURtRSxLQUFwRixDQURtQixHQUd0QixFQUhQOztBQU1BLFFBQUkvQixLQUFLLENBQUNLLE9BQU4sQ0FBY3dCLG9CQUFkLENBQUosRUFBeUM7QUFDdkN0RSxNQUFBQSxHQUFHLENBQUMyRCxNQUFKLENBQVc1QyxJQUFYLENBQWdCLEdBQUd1RCxvQkFBbkI7QUFDQW5FLE1BQUFBLE1BQU0sQ0FBQ1ksSUFBUCxDQUFZLEdBQUd1RCxvQkFBZjtBQUNEOztBQUVELFFBQUk3QixLQUFLLENBQUNLLE9BQU4sQ0FBYzJCLG9CQUFkLENBQUosRUFBeUM7QUFDdkN6RSxNQUFBQSxHQUFHLENBQUMyRCxNQUFKLENBQVc1QyxJQUFYLENBQWdCLEdBQUcwRCxvQkFBbkI7QUFDQXRFLE1BQUFBLE1BQU0sQ0FBQ1ksSUFBUCxDQUFZLEdBQUcwRCxvQkFBZjtBQUNEO0FBQ0Y7QUFDRjs7ZUFFY3pELFkiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1hd2FpdC1pbi1sb29wICovXG4vKiBlc2xpbnQtZGlzYWJsZSBuby11bmRlcnNjb3JlLWRhbmdsZSAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tY2FzZS1kZWNsYXJhdGlvbnMgKi9cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgcmVzb2x2ZU5vZGUsIHsgcG9wUGF0aCB9IGZyb20gJy4vcmVzb2x2ZXInO1xuaW1wb3J0IHJlc29sdmVEZWZpbml0aW9uIGZyb20gJy4vcmVzb2x2ZURlZmluaXRpb24nO1xuaW1wb3J0IHJlc29sdmVUeXBlIGZyb20gJy4vcmVzb2x2ZVR5cGUnO1xuaW1wb3J0IHJlc29sdmVTY2FsYXJzIGZyb20gJy4vc2NhbGFyc1Jlc29sdmVyJztcblxuaW1wb3J0IHsgZnJvbUVycm9yLCBjcmVhdGVFcnJvckZsYXQgfSBmcm9tICcuL2Vycm9yL2RlZmF1bHQnO1xuXG5hc3luYyBmdW5jdGlvbiB0cmF2ZXJzZUNoaWxkcmVuKHJlc29sdmVkTm9kZSwgZGVmaW5pdGlvbiwgY3R4LCB2aXNpdGVkKSB7XG4gIGxldCBub2RlQ2hpbGRyZW47XG4gIGNvbnN0IGVycm9ycyA9IFtdO1xuICBzd2l0Y2ggKHR5cGVvZiBkZWZpbml0aW9uLnByb3BlcnRpZXMpIHtcbiAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICBub2RlQ2hpbGRyZW4gPSBkZWZpbml0aW9uLnByb3BlcnRpZXMocmVzb2x2ZWROb2RlKTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuTmFtZXMgPSBPYmplY3Qua2V5cyhub2RlQ2hpbGRyZW4pO1xuICAgICAgY29uc3QgcmVzb2x2ZWROb2RlS2V5cyA9IE9iamVjdC5rZXlzKHJlc29sdmVkTm9kZSk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuTmFtZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbk5hbWVzW2ldO1xuICAgICAgICBsZXQgY2hpbGRSZXN1bHQgPSBbXTtcbiAgICAgICAgaWYgKHJlc29sdmVkTm9kZUtleXMuaW5jbHVkZXMoY2hpbGQpKSB7XG4gICAgICAgICAgY3R4LnBhdGgucHVzaChjaGlsZCk7XG4gICAgICAgICAgaWYgKHJlc29sdmVkTm9kZVtjaGlsZF0pIHtcbiAgICAgICAgICAgIGNoaWxkUmVzdWx0ID0gYXdhaXQgdHJhdmVyc2VOb2RlKHJlc29sdmVkTm9kZVtjaGlsZF0sIG5vZGVDaGlsZHJlbltjaGlsZF0sIGN0eCwgdmlzaXRlZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjaGlsZFJlc3VsdCkgZXJyb3JzLnB1c2goLi4uY2hpbGRSZXN1bHQpO1xuICAgICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICBjb25zdCBwcm9wcyA9IE9iamVjdC5rZXlzKGRlZmluaXRpb24ucHJvcGVydGllcyk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IHAgPSBwcm9wc1tpXTtcbiAgICAgICAgbGV0IHByb3BSZXN1bHQgPSBbXTtcbiAgICAgICAgY3R4LnBhdGgucHVzaChwKTtcbiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICBpZiAocmVzb2x2ZWROb2RlW3BdKSB7XG4gICAgICAgICAgICBwcm9wUmVzdWx0ID0gYXdhaXQgdHJhdmVyc2VOb2RlKHJlc29sdmVkTm9kZVtwXSwgZGVmaW5pdGlvbi5wcm9wZXJ0aWVzW3BdKHJlc29sdmVkTm9kZVtwXSksIGN0eCwgdmlzaXRlZCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHJlc29sdmVkTm9kZVtwXSkge1xuICAgICAgICAgIHByb3BSZXN1bHQgPSBhd2FpdCB0cmF2ZXJzZU5vZGUocmVzb2x2ZWROb2RlW3BdLCBkZWZpbml0aW9uLnByb3BlcnRpZXNbcF0sIGN0eCwgdmlzaXRlZCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3BSZXN1bHQpIGVycm9ycy5wdXNoKC4uLnByb3BSZXN1bHQpO1xuICAgICAgICBjdHgucGF0aC5wb3AoKTtcbiAgICAgIH1cblxuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgICAgLy8gZG8gbm90aGluZ1xuICB9XG4gIHJldHVybiBlcnJvcnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG9uTm9kZUVudGVyKG5vZGUsIGN0eCkge1xuICBjb25zdCB7XG4gICAgbm9kZTogcmVzb2x2ZWROb2RlLCBvblN0YWNrLFxuICB9ID0gYXdhaXQgcmVzb2x2ZU5vZGUobm9kZSwgY3R4KTtcblxuICByZXR1cm4ge1xuICAgIHJlc29sdmVkTm9kZSxcbiAgICBvblN0YWNrLFxuICB9O1xufVxuXG5mdW5jdGlvbiBvbk5vZGVFeGl0KG5vZGVDb250ZXh0LCBjdHgpIHtcbiAgaWYgKG5vZGVDb250ZXh0Lm9uU3RhY2spIHtcbiAgICBwb3BQYXRoKGN0eCk7XG4gIH1cbn1cblxuY29uc3QgbmVzdGVkSW5jbHVkZXMgPSAoYywgcykgPT4ge1xuICBjb25zdCByZXMgPSBzLmZpbmQoKGVsKSA9PiBlbCA9PT0gcykgIT09IHVuZGVmaW5lZDtcbiAgcmV0dXJuIHJlcztcbn07XG5cblxuYXN5bmMgZnVuY3Rpb24gdHJhdmVyc2VOb2RlKG5vZGUsIGRlZmluaXRpb24sIGN0eCwgdmlzaXRlZCA9IFtdKSB7XG4gIGlmICghbm9kZSB8fCAhZGVmaW5pdGlvbikgcmV0dXJuIFtdO1xuXG4gIGNvbnN0IG5vZGVDb250ZXh0ID0gYXdhaXQgb25Ob2RlRW50ZXIobm9kZSwgY3R4KTtcbiAgY29uc3QgaXNSZWN1cnNpdmUgPSBuZXN0ZWRJbmNsdWRlcyhjdHgucGF0aCwgdmlzaXRlZCk7XG4gIGNvbnN0IGVycm9ycyA9IFtdO1xuICBjb25zdCBjdXJyZW50UGF0aCA9IGAke3BhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgY3R4LmZpbGVQYXRoKX06OiR7Y3R4LnBhdGguam9pbignLycpfWA7XG5cbiAgY29uc3QgbG9jYWxWaXNpdGVkID0gQXJyYXkuZnJvbSh2aXNpdGVkKTtcbiAgbG9jYWxWaXNpdGVkLnB1c2goY3VycmVudFBhdGgpO1xuXG4gIGNvbnN0IHJlc29sdmVkRGVmaW5pdGlvbiA9IHJlc29sdmVEZWZpbml0aW9uKGRlZmluaXRpb24sIGN0eCwgbm9kZUNvbnRleHQucmVzb2x2ZWROb2RlKTtcblxuICBjdHguZGVmaW5pdGlvblN0YWNrLnB1c2gocmVzb2x2ZWREZWZpbml0aW9uKTtcbiAgcmVzb2x2ZVNjYWxhcnMobm9kZUNvbnRleHQucmVzb2x2ZWROb2RlLCBkZWZpbml0aW9uLCBjdHgpO1xuXG4gIGlmIChkZWZpbml0aW9uLmN1c3RvbVJlc29sdmVGaWVsZHMpIHtcbiAgICBhd2FpdCBkZWZpbml0aW9uLmN1c3RvbVJlc29sdmVGaWVsZHMobm9kZUNvbnRleHQucmVzb2x2ZWROb2RlLCBjdHgsIHZpc2l0ZWQpO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkobm9kZUNvbnRleHQucmVzb2x2ZWROb2RlKSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZUNvbnRleHQucmVzb2x2ZWROb2RlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjdHgucGF0aC5wdXNoKGkpO1xuICAgICAgY29uc3QgYXJyYXlSZXN1bHQgPSBhd2FpdCB0cmF2ZXJzZU5vZGUobm9kZUNvbnRleHQucmVzb2x2ZWROb2RlW2ldLCByZXNvbHZlZERlZmluaXRpb24sIGN0eCwgbG9jYWxWaXNpdGVkKTtcbiAgICAgIGlmIChhcnJheVJlc3VsdCkgZXJyb3JzLnB1c2goLi4uYXJyYXlSZXN1bHQpO1xuICAgICAgY3R4LnBhdGgucG9wKCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGN0eC52YWxpZGF0ZUZpZWxkcyA9IGN0eC52YWxpZGF0ZUZpZWxkc1Jhdy5iaW5kKFxuICAgICAgbnVsbCwgbm9kZUNvbnRleHQucmVzb2x2ZWROb2RlLCBjdHgsXG4gICAgKTtcbiAgICBhd2FpdCBydW5SdWxlT25SdWxlc2V0KG5vZGVDb250ZXh0LCAnb25FbnRlcicsIGN0eCwgcmVzb2x2ZWREZWZpbml0aW9uLCBub2RlLCBlcnJvcnMsIGxvY2FsVmlzaXRlZCk7XG5cbiAgICBjb25zdCBuZXdOb2RlID0gIWlzUmVjdXJzaXZlXG4gICAgICAmJiAoIXJlc29sdmVkRGVmaW5pdGlvbi5pc0lkZW1wb3RlbnQgfHwgIWN0eC52aXNpdGVkLmluY2x1ZGVzKGN1cnJlbnRQYXRoKSk7XG4gICAgaWYgKG5ld05vZGUpIHtcbiAgICAgIGlmICghY3R4LnZpc2l0ZWQuaW5jbHVkZXMoY3VycmVudFBhdGgpKSBjdHgudmlzaXRlZC5wdXNoKGN1cnJlbnRQYXRoKTtcblxuICAgICAgY29uc3QgZXJyb3JzQ2hpbGRyZW4gPSBhd2FpdCB0cmF2ZXJzZUNoaWxkcmVuKFxuICAgICAgICBub2RlQ29udGV4dC5yZXNvbHZlZE5vZGUsIHJlc29sdmVkRGVmaW5pdGlvbiwgY3R4LCBsb2NhbFZpc2l0ZWQsXG4gICAgICApO1xuICAgICAgZXJyb3JzLnB1c2goLi4uZXJyb3JzQ2hpbGRyZW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBXaWxsIHVzZSBjYWNoZWQgcmVzdWx0IGlmIHdlIGhhdmUgYWxyZWFkeSB0cmF2ZXJzZWQgdGhpcyBub2RlcyBjaGlsZHJlblxuICAgICAgY29uc3QgY2FjaGVkUmVzdWx0ID0gY3R4LmNhY2hlW2N1cnJlbnRQYXRoXVxuICAgICAgICA/IGN0eC5jYWNoZVtjdXJyZW50UGF0aF0ubWFwKChyKSA9PiBmcm9tRXJyb3IociwgY3R4KSlcbiAgICAgICAgOiBbXTtcblxuICAgICAgY3R4LnJlc3VsdC5wdXNoKC4uLmNhY2hlZFJlc3VsdCk7XG4gICAgfVxuXG4gICAgYXdhaXQgcnVuUnVsZU9uUnVsZXNldChub2RlQ29udGV4dCwgJ29uRXhpdCcsIGN0eCwgcmVzb2x2ZWREZWZpbml0aW9uLCBub2RlLCBlcnJvcnMpO1xuICAgIGlmIChuZXdOb2RlKSBjdHguY2FjaGVbY3VycmVudFBhdGhdID0gZXJyb3JzO1xuICB9XG4gIG9uTm9kZUV4aXQobm9kZUNvbnRleHQsIGN0eCk7XG4gIGN0eC5kZWZpbml0aW9uU3RhY2sucG9wKCk7XG4gIHJldHVybiBlcnJvcnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blJ1bGVPblJ1bGVzZXQobm9kZUNvbnRleHQsIHJ1bGVOYW1lLCBjdHgsIGRlZmluaXRpb24sIG5vZGUsIGVycm9ycywgdmlzaXRlZCkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGN0eC5jdXN0b21SdWxlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgIGN0eC52YWxpZGF0ZUZpZWxkc0hlbHBlciA9IGN0eC52YWxpZGF0ZUZpZWxkcy5iaW5kKFxuICAgICAgbnVsbCxcbiAgICAgIGN0eC5jdXN0b21SdWxlc1tpXS5fY29uZmlnLFxuICAgICAgY3R4LmN1c3RvbVJ1bGVzW2ldLmNvbnN0cnVjdG9yLnJ1bGUsXG4gICAgKTtcblxuICAgIGN0eC5jcmVhdGVFcnJvciA9IGNyZWF0ZUVycm9yRmxhdC5iaW5kKFxuICAgICAgbnVsbCxcbiAgICAgIG5vZGVDb250ZXh0LnJlc29sdmVkTm9kZSxcbiAgICAgIGN0eCxcbiAgICAgIGN0eC5jdXN0b21SdWxlc1tpXS5jb25zdHJ1Y3Rvci5ydWxlLFxuICAgICAgY3R4LmN1c3RvbVJ1bGVzW2ldLmNvbmZpZ1xuICAgICAgICA/IGN0eC5jdXN0b21SdWxlc1tpXS5jb25maWcubGV2ZWwgOiBjdHguY3VzdG9tUnVsZXNbaV0uX2NvbmZpZy5sZXZlbCxcbiAgICApO1xuXG4gICAgY29uc3QgZXJyb3JzT25FbnRlckZvclR5cGUgPSBjdHguY3VzdG9tUnVsZXNbaV1bZGVmaW5pdGlvbi5uYW1lXVxuICAgICAgJiYgY3R4LmN1c3RvbVJ1bGVzW2ldW2RlZmluaXRpb24ubmFtZV0oKVtydWxlTmFtZV1cbiAgICAgID8gYXdhaXQgY3R4LmN1c3RvbVJ1bGVzW2ldW2RlZmluaXRpb24ubmFtZV0oKVtydWxlTmFtZV0oXG4gICAgICAgIG5vZGVDb250ZXh0LnJlc29sdmVkTm9kZSwgZGVmaW5pdGlvbiwgY3R4LCBub2RlLCB7IHRyYXZlcnNlTm9kZSwgdmlzaXRlZCwgcmVzb2x2ZVR5cGUgfSxcbiAgICAgICkgOiBbXTtcblxuICAgIGNvbnN0IGVycm9yc09uRW50ZXJHZW5lcmljID0gY3R4LmN1c3RvbVJ1bGVzW2ldLmFueSAmJiBjdHguY3VzdG9tUnVsZXNbaV0uYW55KClbcnVsZU5hbWVdXG4gICAgICA/IGF3YWl0IGN0eC5jdXN0b21SdWxlc1tpXS5hbnkoKVtydWxlTmFtZV0obm9kZUNvbnRleHQucmVzb2x2ZWROb2RlLCBkZWZpbml0aW9uLCBjdHgsIG5vZGUsIHtcbiAgICAgICAgdHJhdmVyc2VOb2RlLCB2aXNpdGVkLCByZXNvbHZlVHlwZSxcbiAgICAgIH0pIDogW107XG5cblxuICAgIGlmIChBcnJheS5pc0FycmF5KGVycm9yc09uRW50ZXJGb3JUeXBlKSkge1xuICAgICAgY3R4LnJlc3VsdC5wdXNoKC4uLmVycm9yc09uRW50ZXJGb3JUeXBlKTtcbiAgICAgIGVycm9ycy5wdXNoKC4uLmVycm9yc09uRW50ZXJGb3JUeXBlKTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShlcnJvcnNPbkVudGVyR2VuZXJpYykpIHtcbiAgICAgIGN0eC5yZXN1bHQucHVzaCguLi5lcnJvcnNPbkVudGVyR2VuZXJpYyk7XG4gICAgICBlcnJvcnMucHVzaCguLi5lcnJvcnNPbkVudGVyR2VuZXJpYyk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHRyYXZlcnNlTm9kZTtcbiJdfQ==