"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.fromError = exports.createErrorFlat = exports.getReferencedFrom = exports.getMsgLevelFromString = exports.messageLevels = void 0;

var _path = _interopRequireDefault(require("path"));

var _yaml = require("../yaml");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const messageLevels = {
  ERROR: 4,
  WARNING: 3,
  INFO: 2,
  DEBUG: 1
};
exports.messageLevels = messageLevels;

const getLocationForPath = (fName, nodePath, target, {
  filePath,
  source
}) => (0, _yaml.getLocationByPath)(Array.from(nodePath), {
  filePath,
  source
}, target).startLine;

const getMsgLevelFromString = severityString => {
  switch (severityString.toLowerCase()) {
    case 'debug':
      return 1;

    case 'info':
      return 2;

    case 'warning':
      return 3;

    case 'error':
    default:
      return 4;
  }
};

exports.getMsgLevelFromString = getMsgLevelFromString;

const getReferencedFrom = ctx => {
  const lastRef = ctx.pathStack[ctx.pathStack.length - 1];
  if (!lastRef) return null;
  return {
    file: _path.default.relative(process.cwd(), lastRef.file),
    startLine: getLocationForPath(lastRef.file, [...lastRef.path, '$ref'], 'key', {
      source: lastRef.source,
      filePath: lastRef.file
    }),
    path: Array.from(lastRef.path)
  };
};

exports.getReferencedFrom = getReferencedFrom;

const createError = (msg, node, ctx, options, overrideSeverity) => {
  const {
    target,
    possibleAlternate,
    fromRule
  } = options;
  let {
    severity = messageLevels.ERROR
  } = options;
  if (overrideSeverity) severity = overrideSeverity;

  if (typeof severity === 'string') {
    severity = getMsgLevelFromString(severity);
  }

  let location = (0, _yaml.getLocationByPath)(Array.from(ctx.path), ctx, target);
  if (!location) location = (0, _yaml.getLocationByPath)(Array.from(ctx.path), ctx);
  return {
    message: msg,
    path: Array.from(ctx.path),
    referencedFrom: getReferencedFrom(ctx),
    location,
    codeFrame: ctx.enableCodeframe && location ? (0, _yaml.getCodeFrameForLocation)(location.startIndex, location.endIndex, ctx.source, location.startLine) : null,
    value: node,
    file: _path.default.relative(process.cwd(), ctx.filePath),
    severity,
    enableCodeframe: ctx.enableCodeframe,
    possibleAlternate,
    fromRule,
    target
  };
};

const createErrorFlat = (node, ctx, fromRule, severity, msg, target, possibleAlternate, overrideSeverity) => createError(msg, node, ctx, {
  target,
  fromRule,
  severity,
  possibleAlternate
}, overrideSeverity);

exports.createErrorFlat = createErrorFlat;

const fromError = (error, ctx) => ( // let location = getLocationByPath(Array.from(ctx.path), ctx, error.target);
// if (!location) location = getLocationByPath(Array.from(ctx.path), ctx);
{ ...error,
  ...ctx,
  document: null,
  source: null,
  path: error.path,
  referencedFrom: getReferencedFrom(ctx)
});

exports.fromError = fromError;
var _default = createError;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lcnJvci9kZWZhdWx0LmpzIl0sIm5hbWVzIjpbIm1lc3NhZ2VMZXZlbHMiLCJFUlJPUiIsIldBUk5JTkciLCJJTkZPIiwiREVCVUciLCJnZXRMb2NhdGlvbkZvclBhdGgiLCJmTmFtZSIsIm5vZGVQYXRoIiwidGFyZ2V0IiwiZmlsZVBhdGgiLCJzb3VyY2UiLCJBcnJheSIsImZyb20iLCJzdGFydExpbmUiLCJnZXRNc2dMZXZlbEZyb21TdHJpbmciLCJzZXZlcml0eVN0cmluZyIsInRvTG93ZXJDYXNlIiwiZ2V0UmVmZXJlbmNlZEZyb20iLCJjdHgiLCJsYXN0UmVmIiwicGF0aFN0YWNrIiwibGVuZ3RoIiwiZmlsZSIsInBhdGgiLCJyZWxhdGl2ZSIsInByb2Nlc3MiLCJjd2QiLCJjcmVhdGVFcnJvciIsIm1zZyIsIm5vZGUiLCJvcHRpb25zIiwib3ZlcnJpZGVTZXZlcml0eSIsInBvc3NpYmxlQWx0ZXJuYXRlIiwiZnJvbVJ1bGUiLCJzZXZlcml0eSIsImxvY2F0aW9uIiwibWVzc2FnZSIsInJlZmVyZW5jZWRGcm9tIiwiY29kZUZyYW1lIiwiZW5hYmxlQ29kZWZyYW1lIiwic3RhcnRJbmRleCIsImVuZEluZGV4IiwidmFsdWUiLCJjcmVhdGVFcnJvckZsYXQiLCJmcm9tRXJyb3IiLCJlcnJvciIsImRvY3VtZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFFTyxNQUFNQSxhQUFhLEdBQUc7QUFDM0JDLEVBQUFBLEtBQUssRUFBRSxDQURvQjtBQUUzQkMsRUFBQUEsT0FBTyxFQUFFLENBRmtCO0FBRzNCQyxFQUFBQSxJQUFJLEVBQUUsQ0FIcUI7QUFJM0JDLEVBQUFBLEtBQUssRUFBRTtBQUpvQixDQUF0Qjs7O0FBT1AsTUFBTUMsa0JBQWtCLEdBQUcsQ0FBQ0MsS0FBRCxFQUFRQyxRQUFSLEVBQWtCQyxNQUFsQixFQUEwQjtBQUFFQyxFQUFBQSxRQUFGO0FBQVlDLEVBQUFBO0FBQVosQ0FBMUIsS0FBbUQsNkJB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QVpDO0FBYUw2QixJQUFBQSxLQUFLLEVBQUViLElBYkY7QUFjTFAsSUFBQUEsSUFBSSxFQUFFQyxjQUFLQyxRQUFMLENBQWNDLE9BQU8sQ0FBQ0MsR0FBUixFQUFkLEVBQTZCUixHQUFHLENBQUNULFFBQWpDLENBZEQ7QUFlTHlCLElBQUFBLFFBZks7QUFnQkxLLElBQUFBLGVBQWUsRUFBRXJCLEdBQUcsQ0FBQ3FCLGVBaEJoQjtBQWlCTFAsSUFBQUEsaUJBakJLO0FBa0JMQyxJQUFBQSxRQWxCSztBQW1CTHpCLElBQUFBO0FBbkJLLEdBQVA7QUFxQkQsQ0FyQ0Q7O0FBdUNPLE1BQU1tQyxlQUFlLEdBQUcsQ0FDN0JkLElBRDZCLEVBQ3ZCWCxHQUR1QixFQUNsQmUsUUFEa0IsRUFDUkMsUUFEUSxFQUNFTixHQURGLEVBQ09wQixNQURQLEVBQ2V3QixpQkFEZixFQUNrQ0QsZ0JBRGxDLEtBRTFCSixXQUFXLENBQUNDLEdBQUQsRUFBTUMsSUFBTixFQUFZWCxHQUFaLEVBQWlCO0FBQy9CVixFQUFBQSxNQUQrQjtBQUN2QnlCLEVBQUFBLFFBRHVCO0FBQ2JDLEVBQUFBLFFBRGE7QUFDSEYsRUFBQUE7QUFERyxDQUFqQixFQUViRCxnQkFGYSxDQUZUOzs7O0FBTUEsTUFBTWEsU0FBUyxHQUFHLENBQUNDLEtBQUQsRUFBUTNCLEdBQVIsT0FDdkI7QUFDQTtBQUNBLEVBQ0UsR0FBRzJCLEtBREw7QUFFRSxLQUFHM0IsR0FGTDtBQUdFNEIsRUFBQUEsUUFBUSxFQUFFLElBSFo7QUFJRXBDLEVBQUFBLE1BQU0sRUFBRSxJQUpWO0FBS0VhLEVBQUFBLElBQUksRUFBRXNCLEtBQUssQ0FBQ3RCLElBTGQ7QUFNRWMsRUFBQUEsY0FBYyxFQUFFcEIsaUJBQWlCLENBQUNDLEdBQUQ7QUFObkMsQ0FIdUIsQ0FBbEI7OztlQWFRUyxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBnZXRMb2NhdGlvbkJ5UGF0aCwgZ2V0Q29kZUZyYW1lRm9yTG9jYXRpb24gfSBmcm9tICcuLi95YW1sJztcblxuZXhwb3J0IGNvbnN0IG1lc3NhZ2VMZXZlbHMgPSB7XG4gIEVSUk9SOiA0LFxuICBXQVJOSU5HOiAzLFxuICBJTkZPOiAyLFxuICBERUJVRzogMSxcbn07XG5cbmNvbnN0IGdldExvY2F0aW9uRm9yUGF0aCA9IChmTmFtZSwgbm9kZVBhdGgsIHRhcmdldCwgeyBmaWxlUGF0aCwgc291cmNlIH0pID0+IGdldExvY2F0aW9uQnlQYXRoKFxuICBBcnJheS5mcm9tKG5vZGVQYXRoKSxcbiAgeyBmaWxlUGF0aCwgc291cmNlIH0sXG4gIHRhcmdldCxcbikuc3RhcnRMaW5lO1xuXG5leHBvcnQgY29uc3QgZ2V0TXNnTGV2ZWxGcm9tU3RyaW5nID0gKHNldmVyaXR5U3RyaW5nKSA9PiB7XG4gIHN3aXRjaCAoc2V2ZXJpdHlTdHJpbmcudG9Mb3dlckNhc2UoKSkge1xuICAgIGNhc2UgJ2RlYnVnJzpcbiAgICAgIHJldHVybiAxO1xuICAgIGNhc2UgJ2luZm8nOlxuICAgICAgcmV0dXJuIDI7XG4gICAgY2FzZSAnd2FybmluZyc6XG4gICAgICByZXR1cm4gMztcbiAgICBjYXNlICdlcnJvcic6XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiA0O1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0UmVmZXJlbmNlZEZyb20gPSAoY3R4KSA9PiB7XG4gIGNvbnN0IGxhc3RSZWYgPSBjdHgucGF0aFN0YWNrW2N0eC5wYXRoU3RhY2subGVuZ3RoIC0gMV07XG4gIGlmICghbGFzdFJlZikgcmV0dXJuIG51bGw7XG4gIHJldHVybiB7XG4gICAgZmlsZTogcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBsYXN0UmVmLmZpbGUpLFxuICAgIHN0YXJ0TGluZTogZ2V0TG9jYXRpb25Gb3JQYXRoKFxuICAgICAgbGFzdFJlZi5maWxlLFxuICAgICAgWy4uLmxhc3RSZWYucGF0aCwgJyRyZWYnXSxcbiAgICAgICdrZXknLFxuICAgICAgeyBzb3VyY2U6IGxhc3RSZWYuc291cmNlLCBmaWxlUGF0aDogbGFzdFJlZi5maWxlIH0sXG4gICAgKSxcbiAgICBwYXRoOiBBcnJheS5mcm9tKGxhc3RSZWYucGF0aCksXG4gIH07XG59O1xuXG5jb25zdCBjcmVhdGVFcnJvciA9IChtc2csIG5vZGUsIGN0eCwgb3B0aW9ucywgb3ZlcnJpZGVTZXZlcml0eSkgPT4ge1xuICBjb25zdCB7XG4gICAgdGFyZ2V0LCBwb3NzaWJsZUFsdGVybmF0ZSwgZnJvbVJ1bGUsXG4gIH0gPSBvcHRpb25zO1xuXG4gIGxldCB7IHNldmVyaXR5ID0gbWVzc2FnZUxldmVscy5FUlJPUiB9ID0gb3B0aW9ucztcblxuICBpZiAob3ZlcnJpZGVTZXZlcml0eSkgc2V2ZXJpdHkgPSBvdmVycmlkZVNldmVyaXR5O1xuXG4gIGlmICh0eXBlb2Ygc2V2ZXJpdHkgPT09ICdzdHJpbmcnKSB7XG4gICAgc2V2ZXJpdHkgPSBnZXRNc2dMZXZlbEZyb21TdHJpbmcoc2V2ZXJpdHkpO1xuICB9XG5cbiAgbGV0IGxvY2F0aW9uID0gZ2V0TG9jYXRpb25CeVBhdGgoQXJyYXkuZnJvbShjdHgucGF0aCksIGN0eCwgdGFyZ2V0KTtcbiAgaWYgKCFsb2NhdGlvbikgbG9jYXRpb24gPSBnZXRMb2NhdGlvbkJ5UGF0aChBcnJheS5mcm9tKGN0eC5wYXRoKSwgY3R4KTtcblxuICByZXR1cm4ge1xuICAgIG1lc3NhZ2U6IG1zZyxcbiAgICBwYXRoOiBBcnJheS5mcm9tKGN0eC5wYXRoKSxcbiAgICByZWZlcmVuY2VkRnJvbTogZ2V0UmVmZXJlbmNlZEZyb20oY3R4KSxcbiAgICBsb2NhdGlvbixcbiAgICBjb2RlRnJhbWU6IGN0eC5lbmFibGVDb2RlZnJhbWUgJiYgbG9jYXRpb25cbiAgICAgID8gZ2V0Q29kZUZyYW1lRm9yTG9jYXRpb24oXG4gICAgICAgIGxvY2F0aW9uLnN0YXJ0SW5kZXgsXG4gICAgICAgIGxvY2F0aW9uLmVuZEluZGV4LFxuICAgICAgICBjdHguc291cmNlLFxuICAgICAgICBsb2NhdGlvbi5zdGFydExpbmUsXG4gICAgICApXG4gICAgICA6IG51bGwsXG4gICAgdmFsdWU6IG5vZGUsXG4gICAgZmlsZTogcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBjdHguZmlsZVBhdGgpLFxuICAgIHNldmVyaXR5LFxuICAgIGVuYWJsZUNvZGVmcmFtZTogY3R4LmVuYWJsZUNvZGVmcmFtZSxcbiAgICBwb3NzaWJsZUFsdGVybmF0ZSxcbiAgICBmcm9tUnVsZSxcbiAgICB0YXJnZXQsXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlRXJyb3JGbGF0ID0gKFxuICBub2RlLCBjdHgsIGZyb21SdWxlLCBzZXZlcml0eSwgbXNnLCB0YXJnZXQsIHBvc3NpYmxlQWx0ZXJuYXRlLCBvdmVycmlkZVNldmVyaXR5LFxuKSA9PiBjcmVhdGVFcnJvcihtc2csIG5vZGUsIGN0eCwge1xuICB0YXJnZXQsIGZyb21SdWxlLCBzZXZlcml0eSwgcG9zc2libGVBbHRlcm5hdGUsXG59LCBvdmVycmlkZVNldmVyaXR5KTtcblxuZXhwb3J0IGNvbnN0IGZyb21FcnJvciA9IChlcnJvciwgY3R4KSA9PiAoXG4gIC8vIGxldCBsb2NhdGlvbiA9IGdldExvY2F0aW9uQnlQYXRoKEFycmF5LmZyb20oY3R4LnBhdGgpLCBjdHgsIGVycm9yLnRhcmdldCk7XG4gIC8vIGlmICghbG9jYXRpb24pIGxvY2F0aW9uID0gZ2V0TG9jYXRpb25CeVBhdGgoQXJyYXkuZnJvbShjdHgucGF0aCksIGN0eCk7XG4gIHtcbiAgICAuLi5lcnJvcixcbiAgICAuLi5jdHgsXG4gICAgZG9jdW1lbnQ6IG51bGwsXG4gICAgc291cmNlOiBudWxsLFxuICAgIHBhdGg6IGVycm9yLnBhdGgsXG4gICAgcmVmZXJlbmNlZEZyb206IGdldFJlZmVyZW5jZWRGcm9tKGN0eCksXG4gIH1cbik7XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZUVycm9yO1xuIl19