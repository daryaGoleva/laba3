"use strict";

/* eslint-disable no-underscore-dangle */
class RegRule {
  static get rule() {
    return 'reg-rule';
  }

  constructor(config) {
    this.ruleSets = {};

    for (const ruleName of Object.keys(config.rules || {})) {
      if (!config.rules[ruleName].on) {
        process.stdout.write(`Missing "on" field on the ${ruleName} subrule of string-matcher. Aborting validation`);
        process.exit(1);
      }

      const [typeName, field] = config.rules[ruleName].on.split('.');
      const rule = {
        not: false,
        ...config.rules[ruleName],
        typeName,
        field,
        name: ruleName
      };
      const regexp = !!rule.regexp && new RegExp(rule.regexp) || null;
      const endsWith = !!rule.endsWith && new RegExp(`${rule.endsWith}$`) || null;

      const startsWithHelper = (node, ctx, expr, inverse) => {
        if (!node[rule.field]) {
          return ctx.createError(`Missing ${rule.field} property required by ${rule.name} rule.`, 'key', undefined, rule.level);
        }

        if (!inverse && node[rule.field].startsWith(expr) || inverse && !node[rule.field].startsWith(expr)) return null;
        ctx.path.push(rule.field);
        const error = ctx.createError(rule.message || `Field ${rule.field} does not starts with: ${expr}. Error was generated by ${rule.name} validation rule.`, 'value', undefined, rule.level);
        ctx.path.pop();
        return error;
      };

      const endsWithHelper = (node, ctx, expr, inverse) => {
        if (!node[rule.field]) {
          return ctx.createError(`Missing ${rule.field} property required by ${rule.name} rule.`, 'key', undefined, rule.level);
        }

        if (!inverse && node[rule.field].endsWith(expr) || inverse && !node[rule.field].endsWith(expr)) return null;
        ctx.path.push(rule.field);
        const error = ctx.createError(rule.message || `Field ${rule.field} does not ends with: ${expr}. Error was generated by ${rule.name} validation rule.`, 'value', undefined, rule.level);
        ctx.path.pop();
        return error;
      };

      const checkForRegexp = (node, ctx, expr, inverse) => {
        if (!inverse && !node[rule.field].match(expr) || inverse && node[rule.field].match(expr)) {
          ctx.path.push(rule.field);
          const error = ctx.createError(rule.message || `Field ${rule.field} does not match regexp: ${expr}. Error was generated by ${rule.name} validation rule.`, 'value', undefined, rule.level);
          ctx.path.pop();
          return error;
        }

        return null;
      };

      const validateRule = (node, ctx) => {
        let error = null;

        if (regexp) {
          error = error || checkForRegexp(node, ctx, regexp, rule.not);
        }

        if (rule.startsWith) {
          error = error || startsWithHelper(node, ctx, rule.startsWith, rule.not);
        }

        if (rule.endsWith) {
          error = error || endsWithHelper(node, ctx, endsWith, rule.not);
        }

        return error;
      };

      rule.validate = validateRule;

      if (!this.ruleSets[rule.typeName]) {
        this.ruleSets[rule.typeName] = [];
      }

      this.ruleSets[rule.typeName].push(rule);
    }
  }

  any() {
    return {
      onExit: (node, definition, ctx) => {
        if (!this.ruleSets[definition.name]) return [];
        const errors = [];

        for (const rule of this.ruleSets[definition.name]) {
          const validationResult = rule.validate(node, ctx);
          if (validationResult) errors.push(validationResult);
        }

        return errors;
      }
    };
  }

}

module.exports = RegRule;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy92aXNpdG9ycy9ydWxlcy9jdXN0b20vcmVnUnVsZS5qcyJdLCJuYW1lcyI6WyJSZWdSdWxlIiwicnVsZSIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwicnVsZVNldHMiLCJydWxlTmFtZSIsIk9iamVjdCIsImtleXMiLCJydWxlcyIsIm9uIiwicHJvY2VzcyIsInN0ZG91dCIsIndyaXRlIiwiZXhpdCIsInR5cGVOYW1lIiwiZmllbGQiLCJzcGxpdCIsIm5vdCIsIm5hbWUiLCJyZWdleHAiLCJSZWdFeHAiLCJlbmRzV2l0aCIsInN0YXJ0c1dpdGhIZWxwZXIiLCJub2RlIiwiY3R4IiwiZXhwciIsImludmVyc2UiLCJjcmVhdGVFcnJvciIsInVuZGVmaW5lZCIsImxldmVsIiwic3RhcnRzV2l0aCIsInBhdGgiLCJwdXNoIiwiZXJyb3IiLCJtZXNzYWdlIiwicG9wIiwiZW5kc1dpdGhIZWxwZXIiLCJjaGVja0ZvclJlZ2V4cCIsIm1hdGNoIiwidmFsaWRhdGVSdWxlIiwidmFsaWRhdGUiLCJhbnkiLCJvbkV4aXQiLCJkZWZpbml0aW9uIiwiZXJyb3JzIiwidmFsaWRhdGlvblJlc3VsdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFFQSxNQUFNQSxPQUFOLENBQWM7QUFDWixhQUFXQyxJQUFYLEdBQWtCO0FBQ2hCLFdBQU8sVUFBUDtBQUNEOztBQUVEQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBUztBQUNsQixTQUFLQyxRQUFMLEdBQWdCLEVBQWhCOztBQUVBLFNBQUssTUFBTUMsUUFBWCxJQUF1QkMsTUFBTSxDQUFDQyxJQUFQLENBQVlKLE1BQU0sQ0FBQ0ssS0FBUCxJQUFnQixFQUE1QixDQUF2QixFQUF3RDtBQUN0RCxVQUFJLENBQUNMLE1BQU0sQ0FBQ0ssS0FBUCxDQUFhSCxRQUFiLEVBQXVCSSxFQUE1QixFQUFnQztBQUM5QkMsUUFBQUEsT0FBTyxDQUFDQyxNQUFSLENBQWVDLEtBQWYsQ0FB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Q0FBQ25CLElBQUQsRUFBT29CLFVBQVAsRUFBbUJuQixHQUFuQixLQUEyQjtBQUNqQyxZQUFJLENBQUMsS0FBS3BCLFFBQUwsQ0FBY3VDLFVBQVUsQ0FBQ3pCLElBQXpCLENBQUwsRUFBcUMsT0FBTyxFQUFQO0FBQ3JDLGNBQU0wQixNQUFNLEdBQUcsRUFBZjs7QUFDQSxhQUFLLE1BQU0zQyxJQUFYLElBQW1CLEtBQUtHLFFBQUwsQ0FBY3VDLFVBQVUsQ0FBQ3pCLElBQXpCLENBQW5CLEVBQW1EO0FBQ2pELGdCQUFNMkIsZ0JBQWdCLEdBQUc1QyxJQUFJLENBQUN1QyxRQUFMLENBQWNqQixJQUFkLEVBQW9CQyxHQUFwQixDQUF6QjtBQUNBLGNBQUlxQixnQkFBSixFQUFzQkQsTUFBTSxDQUFDWixJQUFQLENBQVlhLGdCQUFaO0FBQ3ZCOztBQUNELGVBQU9ELE1BQVA7QUFDRDtBQVRJLEtBQVA7QUFXRDs7QUF6R1c7O0FBNEdkRSxNQUFNLENBQUNDLE9BQVAsR0FBaUIvQyxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXVuZGVyc2NvcmUtZGFuZ2xlICovXG5cbmNsYXNzIFJlZ1J1bGUge1xuICBzdGF0aWMgZ2V0IHJ1bGUoKSB7XG4gICAgcmV0dXJuICdyZWctcnVsZSc7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihjb25maWcpIHtcbiAgICB0aGlzLnJ1bGVTZXRzID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHJ1bGVOYW1lIG9mIE9iamVjdC5rZXlzKGNvbmZpZy5ydWxlcyB8fCB7fSkpIHtcbiAgICAgIGlmICghY29uZmlnLnJ1bGVzW3J1bGVOYW1lXS5vbikge1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShgTWlzc2luZyBcIm9uXCIgZmllbGQgb24gdGhlICR7cnVsZU5hbWV9IHN1YnJ1bGUgb2Ygc3RyaW5nLW1hdGNoZXIuIEFib3J0aW5nIHZhbGlkYXRpb25gKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBbdHlwZU5hbWUsIGZpZWxkXSA9IGNvbmZpZy5ydWxlc1tydWxlTmFtZV0ub24uc3BsaXQoJy4nKTtcbiAgICAgIGNvbnN0IHJ1bGUgPSB7XG4gICAgICAgIG5vdDogZmFsc2UsXG4gICAgICAgIC4uLmNvbmZpZy5ydWxlc1tydWxlTmFtZV0sXG4gICAgICAgIHR5cGVOYW1lLFxuICAgICAgICBmaWVsZCxcbiAgICAgICAgbmFtZTogcnVsZU5hbWUsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZWdleHAgPSAoISFydWxlLnJlZ2V4cCAmJiBuZXcgUmVnRXhwKHJ1bGUucmVnZXhwKSkgfHwgbnVsbDtcbiAgICAgIGNvbnN0IGVuZHNXaXRoID0gKCEhcnVsZS5lbmRzV2l0aCAmJiBuZXcgUmVnRXhwKGAke3J1bGUuZW5kc1dpdGh9JGApKSB8fCBudWxsO1xuXG4gICAgICBjb25zdCBzdGFydHNXaXRoSGVscGVyID0gKG5vZGUsIGN0eCwgZXhwciwgaW52ZXJzZSkgPT4ge1xuICAgICAgICBpZiAoIW5vZGVbcnVsZS5maWVsZF0pIHtcbiAgICAgICAgICByZXR1cm4gY3R4LmNyZWF0ZUVycm9yKGBNaXNzaW5nICR7cnVsZS5maWVsZH0gcHJvcGVydHkgcmVxdWlyZWQgYnkgJHtydWxlLm5hbWV9IHJ1bGUuYCwgJ2tleScsIHVuZGVmaW5lZCwgcnVsZS5sZXZlbCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoKCFpbnZlcnNlICYmIG5vZGVbcnVsZS5maWVsZF0uc3RhcnRzV2l0aChleHByKSkgfHwgKGludmVyc2UgJiYgIW5vZGVbcnVsZS5maWVsZF0uc3RhcnRzV2l0aChleHByKSkpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGN0eC5wYXRoLnB1c2gocnVsZS5maWVsZCk7XG4gICAgICAgIGNvbnN0IGVycm9yID0gY3R4LmNyZWF0ZUVycm9yKHJ1bGUubWVzc2FnZVxuICAgICAgICAgICAgfHwgYEZpZWxkICR7cnVsZS5maWVsZH0gZG9lcyBub3Qgc3RhcnRzIHdpdGg6ICR7ZXhwcn0uIEVycm9yIHdhcyBnZW5lcmF0ZWQgYnkgJHtydWxlLm5hbWV9IHZhbGlkYXRpb24gcnVsZS5gLFxuICAgICAgICAndmFsdWUnLCB1bmRlZmluZWQsIHJ1bGUubGV2ZWwpO1xuICAgICAgICBjdHgucGF0aC5wb3AoKTtcbiAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgICAgfTtcblxuICAgICAgY29uc3QgZW5kc1dpdGhIZWxwZXIgPSAobm9kZSwgY3R4LCBleHByLCBpbnZlcnNlKSA9PiB7XG4gICAgICAgIGlmICghbm9kZVtydWxlLmZpZWxkXSkge1xuICAgICAgICAgIHJldHVybiBjdHguY3JlYXRlRXJyb3IoYE1pc3NpbmcgJHtydWxlLmZpZWxkfSBwcm9wZXJ0eSByZXF1aXJlZCBieSAke3J1bGUubmFtZX0gcnVsZS5gLCAna2V5JywgdW5kZWZpbmVkLCBydWxlLmxldmVsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgoIWludmVyc2UgJiYgbm9kZVtydWxlLmZpZWxkXS5lbmRzV2l0aChleHByKSkgfHwgKGludmVyc2UgJiYgIW5vZGVbcnVsZS5maWVsZF0uZW5kc1dpdGgoZXhwcikpKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjdHgucGF0aC5wdXNoKHJ1bGUuZmllbGQpO1xuICAgICAgICBjb25zdCBlcnJvciA9IGN0eC5jcmVhdGVFcnJvcihydWxlLm1lc3NhZ2VcbiAgICAgICAgICAgIHx8IGBGaWVsZCAke3J1bGUuZmllbGR9IGRvZXMgbm90IGVuZHMgd2l0aDogJHtleHByfS4gRXJyb3Igd2FzIGdlbmVyYXRlZCBieSAke3J1bGUubmFtZX0gdmFsaWRhdGlvbiBydWxlLmAsXG4gICAgICAgICd2YWx1ZScsIHVuZGVmaW5lZCwgcnVsZS5sZXZlbCk7XG4gICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjaGVja0ZvclJlZ2V4cCA9IChub2RlLCBjdHgsIGV4cHIsIGludmVyc2UpID0+IHtcbiAgICAgICAgaWYgKCghaW52ZXJzZSAmJiAhbm9kZVtydWxlLmZpZWxkXS5tYXRjaChleHByKSkgfHwgKGludmVyc2UgJiYgbm9kZVtydWxlLmZpZWxkXS5tYXRjaChleHByKSkpIHtcbiAgICAgICAgICBjdHgucGF0aC5wdXNoKHJ1bGUuZmllbGQpO1xuICAgICAgICAgIGNvbnN0IGVycm9yID0gY3R4LmNyZWF0ZUVycm9yKHJ1bGUubWVzc2FnZVxuICAgICAgICAgICAgfHwgYEZpZWxkICR7cnVsZS5maWVsZH0gZG9lcyBub3QgbWF0Y2ggcmVnZXhwOiAke2V4cHJ9LiBFcnJvciB3YXMgZ2VuZXJhdGVkIGJ5ICR7cnVsZS5uYW1lfSB2YWxpZGF0aW9uIHJ1bGUuYCxcbiAgICAgICAgICAndmFsdWUnLCB1bmRlZmluZWQsIHJ1bGUubGV2ZWwpO1xuICAgICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHZhbGlkYXRlUnVsZSA9IChub2RlLCBjdHgpID0+IHtcbiAgICAgICAgbGV0IGVycm9yID0gbnVsbDtcbiAgICAgICAgaWYgKHJlZ2V4cCkge1xuICAgICAgICAgIGVycm9yID0gZXJyb3IgfHwgY2hlY2tGb3JSZWdleHAobm9kZSwgY3R4LCByZWdleHAsIHJ1bGUubm90KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocnVsZS5zdGFydHNXaXRoKSB7XG4gICAgICAgICAgZXJyb3IgPSBlcnJvciB8fCBzdGFydHNXaXRoSGVscGVyKG5vZGUsIGN0eCwgcnVsZS5zdGFydHNXaXRoLCBydWxlLm5vdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJ1bGUuZW5kc1dpdGgpIHtcbiAgICAgICAgICBlcnJvciA9IGVycm9yIHx8IGVuZHNXaXRoSGVscGVyKG5vZGUsIGN0eCwgZW5kc1dpdGgsIHJ1bGUubm90KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgIH07XG5cbiAgICAgIHJ1bGUudmFsaWRhdGUgPSB2YWxpZGF0ZVJ1bGU7XG5cbiAgICAgIGlmICghdGhpcy5ydWxlU2V0c1tydWxlLnR5cGVOYW1lXSkge1xuICAgICAgICB0aGlzLnJ1bGVTZXRzW3J1bGUudHlwZU5hbWVdID0gW107XG4gICAgICB9XG5cbiAgICAgIHRoaXMucnVsZVNldHNbcnVsZS50eXBlTmFtZV0ucHVzaChydWxlKTtcbiAgICB9XG4gIH1cblxuICBhbnkoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9uRXhpdDogKG5vZGUsIGRlZmluaXRpb24sIGN0eCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMucnVsZVNldHNbZGVmaW5pdGlvbi5uYW1lXSkgcmV0dXJuIFtdO1xuICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBydWxlIG9mIHRoaXMucnVsZVNldHNbZGVmaW5pdGlvbi5uYW1lXSkge1xuICAgICAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBydWxlLnZhbGlkYXRlKG5vZGUsIGN0eCk7XG4gICAgICAgICAgaWYgKHZhbGlkYXRpb25SZXN1bHQpIGVycm9ycy5wdXNoKHZhbGlkYXRpb25SZXN1bHQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlcnJvcnM7XG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBSZWdSdWxlO1xuIl19