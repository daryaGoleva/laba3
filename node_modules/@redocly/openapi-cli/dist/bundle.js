"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.bundle = exports.bundleToFile = void 0;

var path = _interopRequireWildcard(require("path"));

var fs = _interopRequireWildcard(require("fs"));

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var _config = require("./config");

var _traverse = _interopRequireDefault(require("./traverse"));

var _context = _interopRequireDefault(require("./context"));

var _OAS = require("./types/OAS3");

var _OAS2 = require("./types/OAS2");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function writeBundleToFile(bundleObject, outputFile) {
  const nameParts = outputFile.split('.');
  const ext = nameParts[nameParts.length - 1];
  const outputPath = path.resolve(outputFile);
  const outputDir = path.dirname(outputPath);
  fs.mkdirSync(outputDir, {
    recursive: true
  });
  let fileData = null;

  switch (ext) {
    case 'json':
      fileData = JSON.stringify(bundleObject, null, 2);
      break;

    case 'yaml':
    case 'yml':
    default:
      fileData = _jsYaml.default.safeDump(bundleObject);
      break;
  }

  fs.writeFileSync(`${outputPath}`, fileData);
}

const bundleToFile = async (fName, outputFile, force) => {
  const resolvedFileName = fName; // path.resolve(fName);

  const {
    document,
    source
  } = (0, _utils.readYaml)(resolvedFileName);

  if (!document.openapi && !document.swagger) {
    return [];
  }

  const lintConfig = (0, _config.getLintConfig)({});
  lintConfig.rules = { ...lintConfig.rules,
    bundler: { ...(lintConfig.rules && typeof lintConfig.rules.bundler === 'object' ? lintConfig.rules.bundler : null),
      output: outputFile,
      ignoreErrors: force
    }
  };
  const ctx = (0, _context.default)(document, source, resolvedFileName, lintConfig);
  const rootNode = ctx.openapiVersion === 3 ? _OAS.OpenAPIRoot : _OAS2.OAS2Root;
  await (0, _traverse.default)(document, rootNode, ctx);

  if (outputFile) {
    writeBundleToFile(ctx.bundlingResult, outputFile);
  } else {
    process.stdout.write(_jsYaml.default.safeDump(ctx.bundlingResult));
    process.stdout.write('\n');
  }

  return ctx.result;
};

exports.bundleToFile = bundleToFile;

const bundle = async (fName, force, options) => {
  const resolvedFileName = fName; // path.resolve(fName);

  const {
    document,
    source
  } = (0, _utils.readYaml)(resolvedFileName);

  if (!document.openapi && !document.swagger) {
    return [];
  }

  const lintConfig = (0, _config.getLintConfig)(options);
  lintConfig.rules = { ...lintConfig.rules,
    bundler: { ...(lintConfig.rules && typeof lintConfig.rules.bundler === 'object' ? lintConfig.rules.bundler : null),
      outputObject: true,
      ignoreErrors: force
    }
  };
  const ctx = (0, _context.default)(document, source, resolvedFileName, lintConfig);
  const rootNode = ctx.openapiVersion === 3 ? _OAS.OpenAPIRoot : _OAS2.OAS2Root;
  await (0, _traverse.default)(document, rootNode, ctx);
  return {
    bundle: ctx.bundlingResult,
    result: ctx.result,
    fileDependencies: ctx.fileDependencies
  };
};

exports.bundle = bundle;
var _default = bundleToFile;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9idW5kbGUuanMiXSwibmFtZXMiOlsid3JpdGVCdW5kbGVUb0ZpbGUiLCJidW5kbGVPYmplY3QiLCJvdXRwdXRGaWxlIiwibmFtZVBhcnRzIiwic3BsaXQiLCJleHQiLCJsZW5ndGgiLCJvdXRwdXRQYXRoIiwicGF0aCIsInJlc29sdmUiLCJvdXRwdXREaXIiLCJkaXJuYW1lIiwiZnMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJmaWxlRGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ5YW1sIiwic2FmZUR1bXAiLCJ3cml0ZUZpbGVTeW5jIiwiYnVuZGxlVG9GaWxlIiwiZk5hbWUiLCJmb3JjZSIsInJlc29sdmVkRmlsZU5hbWUiLCJkb2N1bWVudCIsInNvdXJjZSIsIm9wZW5hcGkiLCJzd2FnZ2VyIiwibGludENvbmZpZyIsInJ1bGVzIiwiYnVuZGxlciIsIm91dHB1dCIsImlnbm9yZUVycm9ycyIsImN0eCIsInJvb3ROb2RlIiwib3BlbmFwaVZlcnNpb24iLCJPcGVuQVBJUm9vdCIsIk9BUzJSb290IiwiYnVuZGxpbmdSZXN1bHQiLCJwcm9jZXNzIiwic3Rkb3V0Iiwid3JpdGUiLCJyZXN1bHQiLCJidW5kbGUiLCJvcHRpb25zIiwib3V0cHV0T2JqZWN0IiwiZmlsZURlcGVuZGVuY2llcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOzs7Ozs7OztBQUVBLFNBQVNBLGlCQUFULENBQTJCQyxZQUEzQixFQUF5Q0MsVUFBekMsRUFBcUQ7QUFDbkQsUUFBTUMsU0FBUyxHQUFHRCxVQUFVLENBQUNFLEtBQVgsQ0FBaUIsR0FBakIsQ0FBbEI7QUFDQSxRQUFNQyxHQUFHLEdBQUdGLFNBQVMsQ0FBQ0EsU0FBUyxDQUFDRyxNQUFWLEdBQW1CLENBQXBCLENBQXJCO0FBRUEsUUFBTUMsVUFBVSxHQUFHQyxJQUFJLENBQUNDLE9BQUwsQ0FBYVAsVUFBYixDQUFuQjtB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OztBQUUxRCxRQUFNQyxVQUFVLEdBQUcsMkJBQWNnQixPQUFkLENBQW5CO0FBQ0FoQixFQUFBQSxVQUFVLENBQUNDLEtBQVgsR0FBbUIsRUFDakIsR0FBR0QsVUFBVSxDQUFDQyxLQURHO0FBRWpCQyxJQUFBQSxPQUFPLEVBQUUsRUFDUCxJQUFJRixVQUFVLENBQUNDLEtBQVgsSUFBb0IsT0FBT0QsVUFBVSxDQUFDQyxLQUFYLENBQWlCQyxPQUF4QixLQUFvQyxRQUF4RCxHQUFtRUYsVUFBVSxDQUFDQyxLQUFYLENBQWlCQyxPQUFwRixHQUE4RixJQUFsRyxDQURPO0FBRVBlLE1BQUFBLFlBQVksRUFBRSxJQUZQO0FBR1BiLE1BQUFBLFlBQVksRUFBRVY7QUFIUDtBQUZRLEdBQW5CO0FBU0EsUUFBTVcsR0FBRyxHQUFHLHNCQUFjVCxRQUFkLEVBQXdCQyxNQUF4QixFQUFnQ0YsZ0JBQWhDLEVBQWtESyxVQUFsRCxDQUFaO0FBRUEsUUFBTU0sUUFBUSxHQUFHRCxHQUFHLENBQUNFLGNBQUosS0FBdUIsQ0FBdkIsR0FBMkJDLGdCQUEzQixHQUF5Q0MsY0FBMUQ7QUFDQSxRQUFNLHVCQUFhYixRQUFiLEVBQXVCVSxRQUF2QixFQUFpQ0QsR0FBakMsQ0FBTjtBQUVBLFNBQU87QUFBRVUsSUFBQUEsTUFBTSxFQUFFVixHQUFHLENBQUNLLGNBQWQ7QUFBOEJJLElBQUFBLE1BQU0sRUFBRVQsR0FBRyxDQUFDUyxNQUExQztBQUFrREksSUFBQUEsZ0JBQWdCLEVBQUViLEdBQUcsQ0FBQ2E7QUFBeEUsR0FBUDtBQUNELENBdEJNOzs7ZUF3QlExQixZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB5YW1sIGZyb20gJ2pzLXlhbWwnO1xuXG5pbXBvcnQgeyBnZXRMaW50Q29uZmlnIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHRyYXZlcnNlTm9kZSBmcm9tICcuL3RyYXZlcnNlJztcbmltcG9ydCBjcmVhdGVDb250ZXh0IGZyb20gJy4vY29udGV4dCc7XG5cbmltcG9ydCB7IE9wZW5BUElSb290IH0gZnJvbSAnLi90eXBlcy9PQVMzJztcbmltcG9ydCB7IE9BUzJSb290IH0gZnJvbSAnLi90eXBlcy9PQVMyJztcblxuaW1wb3J0IHsgcmVhZFlhbWwgfSBmcm9tICcuL3V0aWxzJztcblxuZnVuY3Rpb24gd3JpdGVCdW5kbGVUb0ZpbGUoYnVuZGxlT2JqZWN0LCBvdXRwdXRGaWxlKSB7XG4gIGNvbnN0IG5hbWVQYXJ0cyA9IG91dHB1dEZpbGUuc3BsaXQoJy4nKTtcbiAgY29uc3QgZXh0ID0gbmFtZVBhcnRzW25hbWVQYXJ0cy5sZW5ndGggLSAxXTtcblxuICBjb25zdCBvdXRwdXRQYXRoID0gcGF0aC5yZXNvbHZlKG91dHB1dEZpbGUpO1xuXG4gIGNvbnN0IG91dHB1dERpciA9IHBhdGguZGlybmFtZShvdXRwdXRQYXRoKTtcbiAgZnMubWtkaXJTeW5jKG91dHB1dERpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cbiAgbGV0IGZpbGVEYXRhID0gbnVsbDtcblxuICBzd2l0Y2ggKGV4dCkge1xuICAgIGNhc2UgJ2pzb24nOlxuICAgICAgZmlsZURhdGEgPSBKU09OLnN0cmluZ2lmeShidW5kbGVPYmplY3QsIG51bGwsIDIpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAneWFtbCc6XG4gICAgY2FzZSAneW1sJzpcbiAgICBkZWZhdWx0OlxuICAgICAgZmlsZURhdGEgPSB5YW1sLnNhZmVEdW1wKGJ1bmRsZU9iamVjdCk7XG4gICAgICBicmVhaztcbiAgfVxuICBmcy53cml0ZUZpbGVTeW5jKGAke291dHB1dFBhdGh9YCwgZmlsZURhdGEpO1xufVxuXG5leHBvcnQgY29uc3QgYnVuZGxlVG9GaWxlID0gYXN5bmMgKGZOYW1lLCBvdXRwdXRGaWxlLCBmb3JjZSkgPT4ge1xuICBjb25zdCByZXNvbHZlZEZpbGVOYW1lID0gZk5hbWU7IC8vIHBhdGgucmVzb2x2ZShmTmFtZSk7XG4gIGNvbnN0IHsgZG9jdW1lbnQsIHNvdXJjZSB9ID0gcmVhZFlhbWwocmVzb2x2ZWRGaWxlTmFtZSk7XG5cbiAgaWYgKCFkb2N1bWVudC5vcGVuYXBpICYmICFkb2N1bWVudC5zd2FnZ2VyKSB7IHJldHVybiBbXTsgfVxuXG4gIGNvbnN0IGxpbnRDb25maWcgPSBnZXRMaW50Q29uZmlnKHt9KTtcbiAgbGludENvbmZpZy5ydWxlcyA9IHtcbiAgICAuLi5saW50Q29uZmlnLnJ1bGVzLFxuICAgIGJ1bmRsZXI6IHtcbiAgICAgIC4uLihsaW50Q29uZmlnLnJ1bGVzICYmIHR5cGVvZiBsaW50Q29uZmlnLnJ1bGVzLmJ1bmRsZXIgPT09ICdvYmplY3QnID8gbGludENvbmZpZy5ydWxlcy5idW5kbGVyIDogbnVsbCksXG4gICAgICBvdXRwdXQ6IG91dHB1dEZpbGUsXG4gICAgICBpZ25vcmVFcnJvcnM6IGZvcmNlLFxuICAgIH0sXG4gIH07XG5cbiAgY29uc3QgY3R4ID0gY3JlYXRlQ29udGV4dChkb2N1bWVudCwgc291cmNlLCByZXNvbHZlZEZpbGVOYW1lLCBsaW50Q29uZmlnKTtcblxuICBjb25zdCByb290Tm9kZSA9IGN0eC5vcGVuYXBpVmVyc2lvbiA9PT0gMyA/IE9wZW5BUElSb290IDogT0FTMlJvb3Q7XG4gIGF3YWl0IHRyYXZlcnNlTm9kZShkb2N1bWVudCwgcm9vdE5vZGUsIGN0eCk7XG5cbiAgaWYgKG91dHB1dEZpbGUpIHtcbiAgICB3cml0ZUJ1bmRsZVRvRmlsZShjdHguYnVuZGxpbmdSZXN1bHQsIG91dHB1dEZpbGUpO1xuICB9IGVsc2Uge1xuICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKHlhbWwuc2FmZUR1bXAoY3R4LmJ1bmRsaW5nUmVzdWx0KSk7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoJ1xcbicpO1xuICB9XG5cbiAgcmV0dXJuIGN0eC5yZXN1bHQ7XG59O1xuXG5leHBvcnQgY29uc3QgYnVuZGxlID0gYXN5bmMgKGZOYW1lLCBmb3JjZSwgb3B0aW9ucykgPT4ge1xuICBjb25zdCByZXNvbHZlZEZpbGVOYW1lID0gZk5hbWU7IC8vIHBhdGgucmVzb2x2ZShmTmFtZSk7XG4gIGNvbnN0IHsgZG9jdW1lbnQsIHNvdXJjZSB9ID0gcmVhZFlhbWwocmVzb2x2ZWRGaWxlTmFtZSk7XG5cbiAgaWYgKCFkb2N1bWVudC5vcGVuYXBpICYmICFkb2N1bWVudC5zd2FnZ2VyKSB7IHJldHVybiBbXTsgfVxuXG4gIGNvbnN0IGxpbnRDb25maWcgPSBnZXRMaW50Q29uZmlnKG9wdGlvbnMpO1xuICBsaW50Q29uZmlnLnJ1bGVzID0ge1xuICAgIC4uLmxpbnRDb25maWcucnVsZXMsXG4gICAgYnVuZGxlcjoge1xuICAgICAgLi4uKGxpbnRDb25maWcucnVsZXMgJiYgdHlwZW9mIGxpbnRDb25maWcucnVsZXMuYnVuZGxlciA9PT0gJ29iamVjdCcgPyBsaW50Q29uZmlnLnJ1bGVzLmJ1bmRsZXIgOiBudWxsKSxcbiAgICAgIG91dHB1dE9iamVjdDogdHJ1ZSxcbiAgICAgIGlnbm9yZUVycm9yczogZm9yY2UsXG4gICAgfSxcbiAgfTtcblxuICBjb25zdCBjdHggPSBjcmVhdGVDb250ZXh0KGRvY3VtZW50LCBzb3VyY2UsIHJlc29sdmVkRmlsZU5hbWUsIGxpbnRDb25maWcpO1xuXG4gIGNvbnN0IHJvb3ROb2RlID0gY3R4Lm9wZW5hcGlWZXJzaW9uID09PSAzID8gT3BlbkFQSVJvb3QgOiBPQVMyUm9vdDtcbiAgYXdhaXQgdHJhdmVyc2VOb2RlKGRvY3VtZW50LCByb290Tm9kZSwgY3R4KTtcblxuICByZXR1cm4geyBidW5kbGU6IGN0eC5idW5kbGluZ1Jlc3VsdCwgcmVzdWx0OiBjdHgucmVzdWx0LCBmaWxlRGVwZW5kZW5jaWVzOiBjdHguZmlsZURlcGVuZGVuY2llcyB9O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgYnVuZGxlVG9GaWxlO1xuIl19