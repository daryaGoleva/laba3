"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getConfig = getConfig;
exports.getLintConfig = getLintConfig;
exports.getDefinitionNames = getDefinitionNames;
exports.getFallbackEntryPointsOrExit = getFallbackEntryPointsOrExit;

var _fs = _interopRequireDefault(require("fs"));

var _mergeDeep = _interopRequireDefault(require("merge-deep"));

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var path = _interopRequireWildcard(require("path"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let warningShown = false;

function getConfig(options) {
  let config = {};
  let {
    configPath
  } = options;

  if (!configPath) {
    configPath = `${process.cwd()}/.openapi-cli.yaml`;

    if (_fs.default.existsSync('.redocly.yaml')) {
      configPath = path.resolve('.redocly.yaml');
    } else if (_fs.default.existsSync('.redocly.yml')) {
      configPath = path.resolve('.redocly.yml');
    } else if (_fs.default.existsSync('.openapi-cli.yaml')) {
      if (!warningShown) process.stderr.write('warning: .openapi-cli.yaml is deprecated, rename to .redocly.yaml\n');
      configPath = path.resolve('.openapi-cli.yaml');
    } else if (_fs.default.existsSync('.openapi-cli.yml')) {
      if (!warningShown) process.stderr.write('warning: .openapi-cli.yml is deprecated, rename to .redocly.yml\n');
      configPath = path.resolve('.openapi-cli.yml');
    }
  }

  const defaultConfigRaw = _fs.default.readFileSync(`${__dirname}/.redocly.yaml`, 'utf-8');

  const defaultConfig = _jsYaml.default.safeLoad(defaultConfigRaw);

  if (_fs.default.existsSync(configPath)) {
    const configRaw = _fs.default.readFileSync(configPath, 'utf-8');

    config = _jsYaml.default.safeLoad(configRaw);

    if (config.rules || config.transformers || config.typeExtension || config.customRules) {
      if (!warningShown) {
        process.stderr.write('warning: top level "rules", "transformers", "typeExtension" and "customRules" ' + 'are deprecated. Move them under the "lint" field.\n');
      }

      warningShown = true;
      config = {
        lint: config
      };
    }
  }

  const resolvedConfig = (0, _mergeDeep.default)(defaultConfig, config, options);
  resolvedConfig.configPath = configPath;
  const lintConfig = resolvedConfig.lint;

  if (!lintConfig.typeExtension) {
    lintConfig.typeExtension = `${__dirname}/typeExtensionDefault.js`;
  } else {
    lintConfig.typeExtension = `${process.cwd()}/${lintConfig.typeExtension}`;
  }

  const definitionResolver = require(lintConfig.typeExtension);

  lintConfig.definitionResolver = definitionResolver;
  lintConfig.customRules = lintConfig.customRules ? `${process.cwd()}/${lintConfig.customRules}` : `${__dirname}/customRulesDefault.js`;

  const rulesExtensions = require(lintConfig.customRules);

  lintConfig.rulesExtensions = rulesExtensions;
  lintConfig.transformers = lintConfig.transformers ? `${process.cwd()}/${lintConfig.transformers}` : `${__dirname}/customRulesDefault.js`;

  const transformingVisitors = require(lintConfig.transformers);

  lintConfig.transformingVisitors = transformingVisitors;

  if (!resolvedConfig.lint) {
    resolvedConfig.lint = {};
  }

  resolvedConfig.lint.headers = (resolvedConfig.resolve && resolvedConfig.resolve.http && resolvedConfig.resolve.http.headers || []).map(header => ({ ...header,
    value: header.envVariable ? process.env[header.envVariable] : header.value
  }));
  return resolvedConfig;
}

function getLintConfig(options) {
  return getConfig(options).lint;
}

function getDefinitionNames(config = getConfig({})) {
  return config.apiDefinitions ? Object.keys(config.apiDefinitions) : null;
}

function getFallbackEntryPointsOrExit(argsEntrypoints, config = getConfig({})) {
  let res = argsEntrypoints;

  if ((!argsEntrypoints || !argsEntrypoints.length) && config.apiDefinitions && Object.keys(config.apiDefinitions).length > 0) {
    res = Object.values(config.apiDefinitions);
  } else if (argsEntrypoints && argsEntrypoints.length && config.apiDefinitions) {
    res = res.map(aliasOrPath => config.apiDefinitions[aliasOrPath] || aliasOrPath);
  }

  if (!res || !res.length) {
    process.stderr.write('error: missing required argument "entryPoints"\n');
    process.exit(1);
  }

  return res;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25maWcuanMiXSwibmFtZXMiOlsid2FybmluZ1Nob3duIiwiZ2V0Q29uZmlnIiwib3B0aW9ucyIsImNvbmZpZyIsImNvbmZpZ1BhdGgiLCJwcm9jZXNzIiwiY3dkIiwiZnMiLCJleGlzdHNTeW5jIiwicGF0aCIsInJlc29sdmUiLCJzdGRlcnIiLCJ3cml0ZSIsImRlZmF1bHRDb25maWdSYXciLCJyZWFkRmlsZVN5bmMiLCJfX2Rpcm5hbWUiLCJkZWZhdWx0Q29uZmlnIiwieWFtbCIsInNhZmVMb2FkIiwiY29uZmlnUmF3IiwicnVsZXMiLCJ0cmFuc2Zvcm1lcnMiLCJ0eXBlRXh0ZW5zaW9uIiwiY3VzdG9tUnVsZXMiLCJsaW50IiwicmVzb2x2ZWRDb25maWciLCJsaW50Q29uZmlnIiwiZGVmaW5pdGlvblJlc29sdmVyIiwicmVxdWlyZSIsInJ1bGVzRXh0ZW5zaW9ucyIsInRyYW5zZm9ybWluZ1Zpc2l0b3JzIiwiaGVhZGVycyIsImh0dHAiLCJtYXAiLCJoZWFkZXIiLCJ2YWx1ZSIsImVudlZhcmlhYmxlIiwiZW52IiwiZ2V0TGludENvbmZpZyIsImdldERlZmluaXRpb25OYW1lcyIsImFwaURlZmluaXRpb25zIiwiT2JqZWN0Iiwia2V5cyIsImdldEZhbGxiYWNrRW50cnlQb2ludHNPckV4aXQiLCJhcmdzRW50cnlwb2ludHMiLCJyZXMiLCJsZW5ndGgiLCJ2YWx1ZXMiLCJhbGlhc09yUGF0aCIsImV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQSxJQUFJQSxZQUFZLEdBQUcsS0FBbkI7O0FBRU8sU0FBU0MsU0FBVCxDQUFtQkMsT0FBbkIsRUFBNEI7QUFDakMsTUFBSUMsTUFBTSxHQUFHLEVBQWI7QUFDQSxNQUFJO0FBQUVDLElBQUFBO0FBQUYsTUFBaUJGLE9BQXJCOztBQUNBLE1BQUksQ0FBQ0UsVUFBTCxFQUFpQjtBQUNmQSxJQUFBQSxVQUFVLEdBQUksR0FBRUMsT0FB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ZS1kZWVwJztcbmltcG9ydCB5YW1sIGZyb20gJ2pzLXlhbWwnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxubGV0IHdhcm5pbmdTaG93biA9IGZhbHNlO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29uZmlnKG9wdGlvbnMpIHtcbiAgbGV0IGNvbmZpZyA9IHt9O1xuICBsZXQgeyBjb25maWdQYXRoIH0gPSBvcHRpb25zO1xuICBpZiAoIWNvbmZpZ1BhdGgpIHtcbiAgICBjb25maWdQYXRoID0gYCR7cHJvY2Vzcy5jd2QoKX0vLm9wZW5hcGktY2xpLnlhbWxgO1xuXG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoJy5yZWRvY2x5LnlhbWwnKSkge1xuICAgICAgY29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZSgnLnJlZG9jbHkueWFtbCcpO1xuICAgIH0gZWxzZSBpZiAoZnMuZXhpc3RzU3luYygnLnJlZG9jbHkueW1sJykpIHtcbiAgICAgIGNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoJy5yZWRvY2x5LnltbCcpO1xuICAgIH0gZWxzZSBpZiAoZnMuZXhpc3RzU3luYygnLm9wZW5hcGktY2xpLnlhbWwnKSkge1xuICAgICAgaWYgKCF3YXJuaW5nU2hvd24pIHByb2Nlc3Muc3RkZXJyLndyaXRlKCd3YXJuaW5nOiAub3BlbmFwaS1jbGkueWFtbCBpcyBkZXByZWNhdGVkLCByZW5hbWUgdG8gLnJlZG9jbHkueWFtbFxcbicpO1xuICAgICAgY29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZSgnLm9wZW5hcGktY2xpLnlhbWwnKTtcbiAgICB9IGVsc2UgaWYgKGZzLmV4aXN0c1N5bmMoJy5vcGVuYXBpLWNsaS55bWwnKSkge1xuICAgICAgaWYgKCF3YXJuaW5nU2hvd24pIHByb2Nlc3Muc3RkZXJyLndyaXRlKCd3YXJuaW5nOiAub3BlbmFwaS1jbGkueW1sIGlzIGRlcHJlY2F0ZWQsIHJlbmFtZSB0byAucmVkb2NseS55bWxcXG4nKTtcbiAgICAgIGNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoJy5vcGVuYXBpLWNsaS55bWwnKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBkZWZhdWx0Q29uZmlnUmF3ID0gZnMucmVhZEZpbGVTeW5jKGAke19fZGlybmFtZX0vLnJlZG9jbHkueWFtbGAsICd1dGYtOCcpO1xuICBjb25zdCBkZWZhdWx0Q29uZmlnID0geWFtbC5zYWZlTG9hZChkZWZhdWx0Q29uZmlnUmF3KTtcblxuICBpZiAoZnMuZXhpc3RzU3luYyhjb25maWdQYXRoKSkge1xuICAgIGNvbnN0IGNvbmZpZ1JhdyA9IGZzLnJlYWRGaWxlU3luYyhjb25maWdQYXRoLCAndXRmLTgnKTtcbiAgICBjb25maWcgPSB5YW1sLnNhZmVMb2FkKGNvbmZpZ1Jhdyk7XG5cbiAgICBpZiAoY29uZmlnLnJ1bGVzIHx8IGNvbmZpZy50cmFuc2Zvcm1lcnMgfHwgY29uZmlnLnR5cGVFeHRlbnNpb24gfHwgY29uZmlnLmN1c3RvbVJ1bGVzKSB7XG4gICAgICBpZiAoIXdhcm5pbmdTaG93bikge1xuICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShcbiAgICAgICAgICAnd2FybmluZzogdG9wIGxldmVsIFwicnVsZXNcIiwgXCJ0cmFuc2Zvcm1lcnNcIiwgXCJ0eXBlRXh0ZW5zaW9uXCIgYW5kIFwiY3VzdG9tUnVsZXNcIiAnXG4gICAgICAgICAgKyAnYXJlIGRlcHJlY2F0ZWQuIE1vdmUgdGhlbSB1bmRlciB0aGUgXCJsaW50XCIgZmllbGQuXFxuJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgd2FybmluZ1Nob3duID0gdHJ1ZTtcbiAgICAgIGNvbmZpZyA9IHsgbGludDogY29uZmlnIH07XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcmVzb2x2ZWRDb25maWcgPSBtZXJnZShkZWZhdWx0Q29uZmlnLCBjb25maWcsIG9wdGlvbnMpO1xuICByZXNvbHZlZENvbmZpZy5jb25maWdQYXRoID0gY29uZmlnUGF0aDtcblxuICBjb25zdCBsaW50Q29uZmlnID0gcmVzb2x2ZWRDb25maWcubGludDtcblxuICBpZiAoIWxpbnRDb25maWcudHlwZUV4dGVuc2lvbikge1xuICAgIGxpbnRDb25maWcudHlwZUV4dGVuc2lvbiA9IGAke19fZGlybmFtZX0vdHlwZUV4dGVuc2lvbkRlZmF1bHQuanNgO1xuICB9IGVsc2Uge1xuICAgIGxpbnRDb25maWcudHlwZUV4dGVuc2lvbiA9IGAke3Byb2Nlc3MuY3dkKCl9LyR7bGludENvbmZpZy50eXBlRXh0ZW5zaW9ufWA7XG4gIH1cblxuICBjb25zdCBkZWZpbml0aW9uUmVzb2x2ZXIgPSByZXF1aXJlKGxpbnRDb25maWcudHlwZUV4dGVuc2lvbik7XG5cbiAgbGludENvbmZpZy5kZWZpbml0aW9uUmVzb2x2ZXIgPSBkZWZpbml0aW9uUmVzb2x2ZXI7XG5cbiAgbGludENvbmZpZy5jdXN0b21SdWxlcyA9IGxpbnRDb25maWcuY3VzdG9tUnVsZXNcbiAgICA/IGAke3Byb2Nlc3MuY3dkKCl9LyR7bGludENvbmZpZy5jdXN0b21SdWxlc31gIDogYCR7X19kaXJuYW1lfS9jdXN0b21SdWxlc0RlZmF1bHQuanNgO1xuICBjb25zdCBydWxlc0V4dGVuc2lvbnMgPSByZXF1aXJlKGxpbnRDb25maWcuY3VzdG9tUnVsZXMpO1xuICBsaW50Q29uZmlnLnJ1bGVzRXh0ZW5zaW9ucyA9IHJ1bGVzRXh0ZW5zaW9ucztcblxuICBsaW50Q29uZmlnLnRyYW5zZm9ybWVycyA9IGxpbnRDb25maWcudHJhbnNmb3JtZXJzXG4gICAgPyBgJHtwcm9jZXNzLmN3ZCgpfS8ke2xpbnRDb25maWcudHJhbnNmb3JtZXJzfWAgOiBgJHtfX2Rpcm5hbWV9L2N1c3RvbVJ1bGVzRGVmYXVsdC5qc2A7XG4gIGNvbnN0IHRyYW5zZm9ybWluZ1Zpc2l0b3JzID0gcmVxdWlyZShsaW50Q29uZmlnLnRyYW5zZm9ybWVycyk7XG4gIGxpbnRDb25maWcudHJhbnNmb3JtaW5nVmlzaXRvcnMgPSB0cmFuc2Zvcm1pbmdWaXNpdG9ycztcblxuICBpZiAoIXJlc29sdmVkQ29uZmlnLmxpbnQpIHtcbiAgICByZXNvbHZlZENvbmZpZy5saW50ID0ge307XG4gIH1cblxuICByZXNvbHZlZENvbmZpZy5saW50LmhlYWRlcnMgPSAoXG4gICAgKFxuICAgICAgcmVzb2x2ZWRDb25maWcucmVzb2x2ZVxuICAgICAgJiYgcmVzb2x2ZWRDb25maWcucmVzb2x2ZS5odHRwXG4gICAgICAmJiByZXNvbHZlZENvbmZpZy5yZXNvbHZlLmh0dHAuaGVhZGVycylcbiAgICB8fCBbXVxuICApLm1hcCgoaGVhZGVyKSA9PiAoe1xuICAgIC4uLmhlYWRlcixcbiAgICB2YWx1ZTogaGVhZGVyLmVudlZhcmlhYmxlID8gcHJvY2Vzcy5lbnZbaGVhZGVyLmVudlZhcmlhYmxlXSA6IGhlYWRlci52YWx1ZSxcbiAgfSkpO1xuXG4gIHJldHVybiByZXNvbHZlZENvbmZpZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldExpbnRDb25maWcob3B0aW9ucykge1xuICByZXR1cm4gZ2V0Q29uZmlnKG9wdGlvbnMpLmxpbnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZpbml0aW9uTmFtZXMoY29uZmlnID0gZ2V0Q29uZmlnKHt9KSkge1xuICByZXR1cm4gY29uZmlnLmFwaURlZmluaXRpb25zID8gT2JqZWN0LmtleXMoY29uZmlnLmFwaURlZmluaXRpb25zKSA6IG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGYWxsYmFja0VudHJ5UG9pbnRzT3JFeGl0KGFyZ3NFbnRyeXBvaW50cywgY29uZmlnID0gZ2V0Q29uZmlnKHt9KSkge1xuICBsZXQgcmVzID0gYXJnc0VudHJ5cG9pbnRzO1xuICBpZiAoXG4gICAgKCFhcmdzRW50cnlwb2ludHMgfHwgIWFyZ3NFbnRyeXBvaW50cy5sZW5ndGgpXG4gICAgJiYgY29uZmlnLmFwaURlZmluaXRpb25zXG4gICAgJiYgT2JqZWN0LmtleXMoY29uZmlnLmFwaURlZmluaXRpb25zKS5sZW5ndGggPiAwXG4gICkge1xuICAgIHJlcyA9IE9iamVjdC52YWx1ZXMoY29uZmlnLmFwaURlZmluaXRpb25zKTtcbiAgfSBlbHNlIGlmIChhcmdzRW50cnlwb2ludHMgJiYgYXJnc0VudHJ5cG9pbnRzLmxlbmd0aCAmJiBjb25maWcuYXBpRGVmaW5pdGlvbnMpIHtcbiAgICByZXMgPSByZXMubWFwKChhbGlhc09yUGF0aCkgPT4gY29uZmlnLmFwaURlZmluaXRpb25zW2FsaWFzT3JQYXRoXSB8fCBhbGlhc09yUGF0aCk7XG4gIH1cblxuICBpZiAoIXJlcyB8fCAhcmVzLmxlbmd0aCkge1xuICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKCdlcnJvcjogbWlzc2luZyByZXF1aXJlZCBhcmd1bWVudCBcImVudHJ5UG9pbnRzXCJcXG4nKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH1cblxuICByZXR1cm4gcmVzO1xufVxuIl19