"use strict";

/* eslint-disable no-underscore-dangle */
class StringMatcher {
  static get rule() {
    return 'string-matcher';
  }

  constructor(config) {
    this.ruleSets = {};

    for (const ruleName of Object.keys(config.rules || {})) {
      if (!config.rules[ruleName].on) {
        process.stdout.write(`Missing "on" field on the ${ruleName} subrule of string-matcher. Aborting validation`);
        process.exit(1);
      }

      const [typeName, field] = config.rules[ruleName].on.split('.');
      const rule = {
        not: false,
        ...config.rules[ruleName],
        typeName,
        field,
        name: ruleName
      };
      const regexp = !!rule.regexp && new RegExp(rule.regexp) || null;

      const startsWithHelper = (node, ctx, expr, inverse) => {
        if (!node[rule.field]) {
          return ctx.createError(`Missing ${rule.field} property required by ${rule.name} rule.`, 'key', undefined, rule.level);
        }

        if (!inverse && node[rule.field].startsWith(expr) || inverse && !node[rule.field].startsWith(expr)) return null;
        ctx.path.push(rule.field);
        const error = ctx.createError(rule.message || `Field ${rule.field} does not starts with: ${expr}. Error was generated by ${rule.name} validation rule.`, 'value', undefined, rule.level);
        ctx.path.pop();
        return error;
      };

      const endsWithHelper = (node, ctx, expr, inverse) => {
        if (!node[rule.field]) {
          return ctx.createError(`Missing ${rule.field} property required by ${rule.name} rule.`, 'key', undefined, rule.level);
        }

        if (!inverse && node[rule.field].endsWith(expr) || inverse && !node[rule.field].endsWith(expr)) return null;
        ctx.path.push(rule.field);
        const error = ctx.createError(rule.message || `Field ${rule.field} does not ends with: ${expr}. Error was generated by ${rule.name} validation rule.`, 'value', undefined, rule.level);
        ctx.path.pop();
        return error;
      };

      const checkForRegexp = (node, ctx, expr, inverse) => {
        if (!inverse && !node[rule.field].match(expr) || inverse && node[rule.field].match(expr)) {
          ctx.path.push(rule.field);
          const error = ctx.createError(rule.message || `Field ${rule.field} does not match regexp: ${expr}. Error was generated by ${rule.name} validation rule.`, 'value', undefined, rule.level);
          ctx.path.pop();
          return error;
        }

        return null;
      };

      const validateRule = (node, ctx) => {
        let error = null;

        if (regexp) {
          error = error || checkForRegexp(node, ctx, regexp, rule.not);
        }

        if (rule.startsWith) {
          error = error || startsWithHelper(node, ctx, rule.startsWith, rule.not);
        }

        if (rule.endsWith) {
          error = error || endsWithHelper(node, ctx, rule.endsWith, rule.not);
        }

        return error;
      };

      rule.validate = validateRule;

      if (!this.ruleSets[rule.typeName]) {
        this.ruleSets[rule.typeName] = [];
      }

      this.ruleSets[rule.typeName].push(rule);
    }
  }

  any() {
    return {
      onExit: (node, definition, ctx) => {
        if (!this.ruleSets[definition.name]) return [];
        const errors = [];

        for (const rule of this.ruleSets[definition.name]) {
          const validationResult = rule.validate(node, ctx);
          if (validationResult) errors.push(validationResult);
        }

        return errors;
      }
    };
  }

}

module.exports = StringMatcher;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy92aXNpdG9ycy9ydWxlcy9jdXN0b20vc3RyaW5nTWF0Y2hlci5qcyJdLCJuYW1lcyI6WyJTdHJpbmdNYXRjaGVyIiwicnVsZSIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwicnVsZVNldHMiLCJydWxlTmFtZSIsIk9iamVjdCIsImtleXMiLCJydWxlcyIsIm9uIiwicHJvY2VzcyIsInN0ZG91dCIsIndyaXRlIiwiZXhpdCIsInR5cGVOYW1lIiwiZmllbGQiLCJzcGxpdCIsIm5vdCIsIm5hbWUiLCJyZWdleHAiLCJSZWdFeHAiLCJzdGFydHNXaXRoSGVscGVyIiwibm9kZSIsImN0eCIsImV4cHIiLCJpbnZlcnNlIiwiY3JlYXRlRXJyb3IiLCJ1bmRlZmluZWQiLCJsZXZlbCIsInN0YXJ0c1dpdGgiLCJwYXRoIiwicHVzaCIsImVycm9yIiwibWVzc2FnZSIsInBvcCIsImVuZHNXaXRoSGVscGVyIiwiZW5kc1dpdGgiLCJjaGVja0ZvclJlZ2V4cCIsIm1hdGNoIiwidmFsaWRhdGVSdWxlIiwidmFsaWRhdGUiLCJhbnkiLCJvbkV4aXQiLCJkZWZpbml0aW9uIiwiZXJyb3JzIiwidmFsaWRhdGlvblJlc3VsdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFFQSxNQUFNQSxhQUFOLENBQW9CO0FBQ2xCLGFBQVdDLElBQVgsR0FBa0I7QUFDaEIsV0FBTyxnQkFBUDtBQUNEOztBQUVEQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBUztBQUNsQixTQUFLQyxRQUFMLEdBQWdCLEVBQWhCOztBQUVBLFNBQUssTUFBTUMsUUFBWCxJQUF1QkMsTUFBTSxDQUFDQyxJQUFQLENBQVlKLE1BQU0sQ0FBQ0ssS0FBUCxJQUFnQixFQUE1QixDQUF2QixFQUF3RDtBQUN0RCxVQUFJLENBQUNMLE1BQU0sQ0FBQ0ssS0FBUCxDQUFhSCxRQUFiLEVBQXVCSSxFQUE1QixFQUFnQztBQUM5QkMsUUFBQUEsT0FBTyxDQUFDQyxNQUFS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LElBQXpCLENBQUwsRUFBcUMsT0FBTyxFQUFQO0FBQ3JDLGNBQU0wQixNQUFNLEdBQUcsRUFBZjs7QUFDQSxhQUFLLE1BQU0zQyxJQUFYLElBQW1CLEtBQUtHLFFBQUwsQ0FBY3VDLFVBQVUsQ0FBQ3pCLElBQXpCLENBQW5CLEVBQW1EO0FBQ2pELGdCQUFNMkIsZ0JBQWdCLEdBQUc1QyxJQUFJLENBQUN1QyxRQUFMLENBQWNsQixJQUFkLEVBQW9CQyxHQUFwQixDQUF6QjtBQUNBLGNBQUlzQixnQkFBSixFQUFzQkQsTUFBTSxDQUFDYixJQUFQLENBQVljLGdCQUFaO0FBQ3ZCOztBQUNELGVBQU9ELE1BQVA7QUFDRDtBQVRJLEtBQVA7QUFXRDs7QUF4R2lCOztBQTJHcEJFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQi9DLGFBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdW5kZXJzY29yZS1kYW5nbGUgKi9cblxuY2xhc3MgU3RyaW5nTWF0Y2hlciB7XG4gIHN0YXRpYyBnZXQgcnVsZSgpIHtcbiAgICByZXR1cm4gJ3N0cmluZy1tYXRjaGVyJztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZykge1xuICAgIHRoaXMucnVsZVNldHMgPSB7fTtcblxuICAgIGZvciAoY29uc3QgcnVsZU5hbWUgb2YgT2JqZWN0LmtleXMoY29uZmlnLnJ1bGVzIHx8IHt9KSkge1xuICAgICAgaWYgKCFjb25maWcucnVsZXNbcnVsZU5hbWVdLm9uKSB7XG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGBNaXNzaW5nIFwib25cIiBmaWVsZCBvbiB0aGUgJHtydWxlTmFtZX0gc3VicnVsZSBvZiBzdHJpbmctbWF0Y2hlci4gQWJvcnRpbmcgdmFsaWRhdGlvbmApO1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IFt0eXBlTmFtZSwgZmllbGRdID0gY29uZmlnLnJ1bGVzW3J1bGVOYW1lXS5vbi5zcGxpdCgnLicpO1xuICAgICAgY29uc3QgcnVsZSA9IHtcbiAgICAgICAgbm90OiBmYWxzZSxcbiAgICAgICAgLi4uY29uZmlnLnJ1bGVzW3J1bGVOYW1lXSxcbiAgICAgICAgdHlwZU5hbWUsXG4gICAgICAgIGZpZWxkLFxuICAgICAgICBuYW1lOiBydWxlTmFtZSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlZ2V4cCA9ICghIXJ1bGUucmVnZXhwICYmIG5ldyBSZWdFeHAocnVsZS5yZWdleHApKSB8fCBudWxsO1xuXG4gICAgICBjb25zdCBzdGFydHNXaXRoSGVscGVyID0gKG5vZGUsIGN0eCwgZXhwciwgaW52ZXJzZSkgPT4ge1xuICAgICAgICBpZiAoIW5vZGVbcnVsZS5maWVsZF0pIHtcbiAgICAgICAgICByZXR1cm4gY3R4LmNyZWF0ZUVycm9yKGBNaXNzaW5nICR7cnVsZS5maWVsZH0gcHJvcGVydHkgcmVxdWlyZWQgYnkgJHtydWxlLm5hbWV9IHJ1bGUuYCwgJ2tleScsIHVuZGVmaW5lZCwgcnVsZS5sZXZlbCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoKCFpbnZlcnNlICYmIG5vZGVbcnVsZS5maWVsZF0uc3RhcnRzV2l0aChleHByKSkgfHwgKGludmVyc2UgJiYgIW5vZGVbcnVsZS5maWVsZF0uc3RhcnRzV2l0aChleHByKSkpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGN0eC5wYXRoLnB1c2gocnVsZS5maWVsZCk7XG4gICAgICAgIGNvbnN0IGVycm9yID0gY3R4LmNyZWF0ZUVycm9yKHJ1bGUubWVzc2FnZVxuICAgICAgICAgICAgfHwgYEZpZWxkICR7cnVsZS5maWVsZH0gZG9lcyBub3Qgc3RhcnRzIHdpdGg6ICR7ZXhwcn0uIEVycm9yIHdhcyBnZW5lcmF0ZWQgYnkgJHtydWxlLm5hbWV9IHZhbGlkYXRpb24gcnVsZS5gLFxuICAgICAgICAndmFsdWUnLCB1bmRlZmluZWQsIHJ1bGUubGV2ZWwpO1xuICAgICAgICBjdHgucGF0aC5wb3AoKTtcbiAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgICAgfTtcblxuICAgICAgY29uc3QgZW5kc1dpdGhIZWxwZXIgPSAobm9kZSwgY3R4LCBleHByLCBpbnZlcnNlKSA9PiB7XG4gICAgICAgIGlmICghbm9kZVtydWxlLmZpZWxkXSkge1xuICAgICAgICAgIHJldHVybiBjdHguY3JlYXRlRXJyb3IoYE1pc3NpbmcgJHtydWxlLmZpZWxkfSBwcm9wZXJ0eSByZXF1aXJlZCBieSAke3J1bGUubmFtZX0gcnVsZS5gLCAna2V5JywgdW5kZWZpbmVkLCBydWxlLmxldmVsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgoIWludmVyc2UgJiYgbm9kZVtydWxlLmZpZWxkXS5lbmRzV2l0aChleHByKSkgfHwgKGludmVyc2UgJiYgIW5vZGVbcnVsZS5maWVsZF0uZW5kc1dpdGgoZXhwcikpKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjdHgucGF0aC5wdXNoKHJ1bGUuZmllbGQpO1xuICAgICAgICBjb25zdCBlcnJvciA9IGN0eC5jcmVhdGVFcnJvcihydWxlLm1lc3NhZ2VcbiAgICAgICAgICAgIHx8IGBGaWVsZCAke3J1bGUuZmllbGR9IGRvZXMgbm90IGVuZHMgd2l0aDogJHtleHByfS4gRXJyb3Igd2FzIGdlbmVyYXRlZCBieSAke3J1bGUubmFtZX0gdmFsaWRhdGlvbiBydWxlLmAsXG4gICAgICAgICd2YWx1ZScsIHVuZGVmaW5lZCwgcnVsZS5sZXZlbCk7XG4gICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjaGVja0ZvclJlZ2V4cCA9IChub2RlLCBjdHgsIGV4cHIsIGludmVyc2UpID0+IHtcbiAgICAgICAgaWYgKCghaW52ZXJzZSAmJiAhbm9kZVtydWxlLmZpZWxkXS5tYXRjaChleHByKSkgfHwgKGludmVyc2UgJiYgbm9kZVtydWxlLmZpZWxkXS5tYXRjaChleHByKSkpIHtcbiAgICAgICAgICBjdHgucGF0aC5wdXNoKHJ1bGUuZmllbGQpO1xuICAgICAgICAgIGNvbnN0IGVycm9yID0gY3R4LmNyZWF0ZUVycm9yKHJ1bGUubWVzc2FnZVxuICAgICAgICAgICAgfHwgYEZpZWxkICR7cnVsZS5maWVsZH0gZG9lcyBub3QgbWF0Y2ggcmVnZXhwOiAke2V4cHJ9LiBFcnJvciB3YXMgZ2VuZXJhdGVkIGJ5ICR7cnVsZS5uYW1lfSB2YWxpZGF0aW9uIHJ1bGUuYCxcbiAgICAgICAgICAndmFsdWUnLCB1bmRlZmluZWQsIHJ1bGUubGV2ZWwpO1xuICAgICAgICAgIGN0eC5wYXRoLnBvcCgpO1xuICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHZhbGlkYXRlUnVsZSA9IChub2RlLCBjdHgpID0+IHtcbiAgICAgICAgbGV0IGVycm9yID0gbnVsbDtcbiAgICAgICAgaWYgKHJlZ2V4cCkge1xuICAgICAgICAgIGVycm9yID0gZXJyb3IgfHwgY2hlY2tGb3JSZWdleHAobm9kZSwgY3R4LCByZWdleHAsIHJ1bGUubm90KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocnVsZS5zdGFydHNXaXRoKSB7XG4gICAgICAgICAgZXJyb3IgPSBlcnJvciB8fCBzdGFydHNXaXRoSGVscGVyKG5vZGUsIGN0eCwgcnVsZS5zdGFydHNXaXRoLCBydWxlLm5vdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJ1bGUuZW5kc1dpdGgpIHtcbiAgICAgICAgICBlcnJvciA9IGVycm9yIHx8IGVuZHNXaXRoSGVscGVyKG5vZGUsIGN0eCwgcnVsZS5lbmRzV2l0aCwgcnVsZS5ub3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVycm9yO1xuICAgICAgfTtcblxuICAgICAgcnVsZS52YWxpZGF0ZSA9IHZhbGlkYXRlUnVsZTtcblxuICAgICAgaWYgKCF0aGlzLnJ1bGVTZXRzW3J1bGUudHlwZU5hbWVdKSB7XG4gICAgICAgIHRoaXMucnVsZVNldHNbcnVsZS50eXBlTmFtZV0gPSBbXTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5ydWxlU2V0c1tydWxlLnR5cGVOYW1lXS5wdXNoKHJ1bGUpO1xuICAgIH1cbiAgfVxuXG4gIGFueSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgb25FeGl0OiAobm9kZSwgZGVmaW5pdGlvbiwgY3R4KSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5ydWxlU2V0c1tkZWZpbml0aW9uLm5hbWVdKSByZXR1cm4gW107XG4gICAgICAgIGNvbnN0IGVycm9ycyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgdGhpcy5ydWxlU2V0c1tkZWZpbml0aW9uLm5hbWVdKSB7XG4gICAgICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IHJ1bGUudmFsaWRhdGUobm9kZSwgY3R4KTtcbiAgICAgICAgICBpZiAodmFsaWRhdGlvblJlc3VsdCkgZXJyb3JzLnB1c2godmFsaWRhdGlvblJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVycm9ycztcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN0cmluZ01hdGNoZXI7XG4iXX0=